<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfriConnect - Find Your Connection</title>
    <meta name="theme-color" content="#fbbf24">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AfriConnect">
    <link rel="manifest" id="pwaManifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
    // Create PWA manifest inline
    const manifest = {
      name: "AfriConnect",
      short_name: "AfriConnect",
      description: "Soul of Africa - Find Your Connection",
      start_url: "./",
      display: "standalone",
      background_color: "#020202",
      theme_color: "#fbbf24",
      orientation: "portrait-primary",
      icons: [
        { src: "https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg", sizes: "192x192", type: "image/jpeg" },
        { src: "https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg", sizes: "512x512", type: "image/jpeg" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    document.getElementById('pwaManifest').href = url;
    </script>
    <style>
        /* Custom Fonts */
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-sans { font-family: 'Lato', sans-serif; }

        /* ===== LIGHT/DARK MODE ===== */
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-card: rgba(255,255,255,0.05);
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: rgba(255,255,255,0.1);
            --input-bg: rgba(255,255,255,0.1);
            --nav-bg: rgba(0,0,0,0.9);
        }
        body.light-mode {
            --bg-primary: #f5f5f0;
            --bg-secondary: #ffffff;
            --bg-card: rgba(0,0,0,0.04);
            --text-primary: #111111;
            --text-secondary: #555555;
            --border-color: rgba(0,0,0,0.1);
            --input-bg: rgba(0,0,0,0.06);
            --nav-bg: rgba(255,255,255,0.95);
        }
        body.light-mode #swipe-interface { background: var(--bg-primary); }
        body.light-mode .app-section { background: var(--bg-primary); }
        body.light-mode .bottom-nav { background: var(--nav-bg); border-color: var(--border-color); }
        body.light-mode .chat-item:hover, body.light-mode .settings-card { background: var(--bg-card); }
        body.light-mode .chat-name, body.light-mode .group-chat-name { color: var(--text-primary); }
        body.light-mode .chat-box, body.light-mode .group-chat-box { background: var(--bg-primary); }
        body.light-mode .chat-input { background: var(--input-bg); color: var(--text-primary); }
        body.light-mode .message.received { background: var(--input-bg); color: var(--text-primary); }
        body.light-mode .main-menu-panel { background: var(--bg-secondary); color: var(--text-primary); }
        body.light-mode .main-menu-user-info h3 { color: var(--text-primary); }
        body.light-mode .main-menu-item { color: var(--text-primary); }
        body.light-mode .main-menu-item:hover { background: rgba(251,191,36,0.15); }
        body.light-mode .settings-card { border: 1px solid var(--border-color); }
        body.light-mode .editable-field { color: var(--text-primary); }
        body.light-mode .flash-post-card { background: var(--bg-secondary); border-color: var(--border-color); }
        body.light-mode .flash-post-card .post-username { color: var(--text-primary); }
        body.light-mode .flash-comment { background: var(--bg-card); }
        body.light-mode .flash-comment-text { color: var(--text-primary); }

        /* ===== DESKTOP MODE ===== */
        body.desktop-mode #swipe-interface {
            max-width: 1200px;
            margin: 0 auto;
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        body.desktop-mode .discovery-grid { grid-template-columns: repeat(6, 1fr); }
        body.desktop-mode .matches-grid { grid-template-columns: repeat(5, 1fr); }
        body.desktop-mode .main-menu-panel { width: 400px; right: -400px; }
        body.desktop-mode .main-menu-panel.active { right: 0; }

        /* ===== FLASH SECTION ===== */
        .flash-feed {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        .flash-post-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .flash-post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
        }
        .flash-post-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fbbf24;
        }
        .post-username { font-weight: bold; color: white; font-size: 14px; }
        .post-time { color: #888; font-size: 11px; }
        .flash-expiry {
            margin-left: auto;
            background: rgba(239,68,68,0.2);
            color: #f87171;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .flash-post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
        }
        .flash-post-caption {
            padding: 10px 14px;
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
        }
        .flash-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 14px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .flash-action-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .flash-action-btn:hover { background: rgba(255,255,255,0.08); color: white; }
        .flash-action-btn.liked { color: #ef4444; }
        .flash-action-btn.liked i { color: #ef4444; }
        .flash-comments-section {
            padding: 0 14px 12px;
            display: none;
        }
        .flash-comments-section.open { display: block; }
        .flash-comment {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 8px 10px;
        }
        .flash-comment-avatar {
            width: 28px; height: 28px; border-radius: 50%; object-fit: cover; flex-shrink: 0;
        }
        .flash-comment-text { color: #ccc; font-size: 12px; line-height: 1.4; }
        .flash-comment-user { color: #fbbf24; font-weight: bold; font-size: 12px; }
        .flash-comment-input-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .flash-comment-input {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 8px 14px;
            color: white;
            font-size: 12px;
            outline: none;
        }
        .flash-comment-input:focus { border-color: #fbbf24; }
        .flash-comment-send {
            background: #fbbf24; color: black; border: none;
            border-radius: 50%; width: 32px; height: 32px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 12px; flex-shrink: 0;
        }
        .flash-create-btn {
            position: fixed;
            bottom: 90px;
            right: 15px;
            width: 52px; height: 52px;
            background: linear-gradient(135deg, #fbbf24, #d4af37);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 85;
            box-shadow: 0 4px 15px rgba(251,191,36,0.5);
            border: none;
            font-size: 22px;
            color: black;
            transition: all 0.3s;
        }
        .flash-create-btn:hover { transform: scale(1.1); }
        .flash-create-btn.visible { display: flex; }
        .flash-create-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 400;
            display: none; flex-direction: column;
            align-items: center; justify-content: flex-start;
            overflow-y: auto;
        }
        .flash-create-modal.active { display: flex; }
        .flash-create-content {
            width: 100%; max-width: 500px; padding: 20px;
        }
        .flash-upload-area {
            border: 2px dashed rgba(251,191,36,0.4);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }
        .flash-upload-area:hover {
            border-color: #fbbf24;
            background: rgba(251,191,36,0.05);
        }
        .flash-timer-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
            color: #f87171; border-radius: 20px;
            padding: 6px 14px; font-size: 13px;
            margin: 12px 0;
        }

        /* Install button */
        .install-btn {
            background: linear-gradient(135deg, #fbbf24, #d4af37);
            color: black;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            margin-top: 8px;
        }
        .install-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(251,191,36,0.4); }
        .install-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* The Dark Room State */
        body {
            background-color: #020202;
            overflow-x: hidden;
            transition: background-color 1.5s ease;
        }

        body.lights-on {
            background-color: #1a1a1a;
        }

        /* Africa Map Background - Fixed with world map style */
        .africa-map-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.4;
            transition: all 2s ease-in-out;
            z-index: 15;
            pointer-events: none;
            transform: scale(1);
        }

        body.lights-on .africa-map-bg {
            opacity: 0.15;
            transform: scale(2.5);
            background-position: 45% 40%;
        }

        /* The Lamp Light Cone - Top Left */
        #lamp-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(circle at 10% 10%, rgba(255, 223, 150, 0.15) 0%, rgba(0, 0, 0, 0.98) 40%);
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 40;
            mix-blend-mode: screen;
        }

        /* The Dark Overlay */
        #darkness-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 10%, rgba(10,10,10,0.2) 0%, rgba(0,0,0,1) 50%);
            pointer-events: none;
            z-index: 30;
            transition: opacity 1.5s ease-in-out;
        }

        body.lights-on #darkness-overlay {
            opacity: 0;
        }

        /* Interface Containers */
        #interface-container {
            opacity: 0;
            transition: opacity 2s ease-in-out;
            filter: blur(5px);
            transform: scale(0.98);
        }

        body.lights-on #interface-container {
            opacity: 1;
            filter: blur(0);
            transform: scale(1);
        }

        /* Dark Welcome */
        #dark-welcome {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 35;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        body.lights-on #dark-welcome {
            opacity: 0;
        }

        .glow-text {
            color: rgba(255, 255, 255, 0.1);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            transition: all 1s ease;
        }

        /* Square Column Table Lamp - Left Side */
        .lamp-container {
            position: fixed;
            top: 20%;
            left: 20px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .lamp-container:active {
            transform: scale(0.98);
        }

        /* Square Column Lamp Base */
        .lamp-base-square {
            width: 80px;
            height: 20px;
            background: linear-gradient(to bottom, #3d2817, #2a1b0f);
            border-radius: 4px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        /* Square Column Lamp Body */
        .lamp-column {
            width: 60px;
            height: 120px;
            background: linear-gradient(to right, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 20%,
                rgba(255, 255, 255, 0.02) 50%,
                rgba(255, 255, 255, 0.05) 80%,
                rgba(255, 255, 255, 0.1) 100%
            );
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            position: relative;
            margin: -2px 0;
            overflow: hidden;
        }

        /* Glass texture effect */
        .lamp-column::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.1) 0%, 
                transparent 50%, 
                rgba(255,255,255,0.05) 100%
            );
        }

        /* Inner light glow */
        .lamp-inner-light {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 80px;
            background: radial-gradient(ellipse, rgba(255, 223, 150, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body.lights-on .lamp-inner-light {
            opacity: 1;
        }

        /* Square Lamp Shade */
        .lamp-shade-square {
            width: 100px;
            height: 70px;
            background: linear-gradient(to bottom, 
                rgba(50, 50, 50, 0.9) 0%,
                rgba(30, 30, 30, 0.95) 50%,
                rgba(10, 10, 10, 1) 100%
            );
            border-radius: 8px 8px 12px 12px;
            position: relative;
            z-index: 52;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Light bulb inside */
        .bulb-glow {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 40px;
            background: radial-gradient(ellipse, #ffeb3b 0%, rgba(255, 235, 59, 0.3) 50%, transparent 70%);
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        body.lights-on .bulb-glow {
            opacity: 0.9;
        }

        /* Rope Switch */
        .rope-switch-container {
            position: absolute;
            right: -30px;
            top: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rope-base {
            width: 8px;
            height: 8px;
            background: #444;
            border-radius: 50%;
        }

        .rope {
            width: 2px;
            height: 60px;
            background: linear-gradient(to right, #8b4513, #a0522d, #8b4513);
            transform-origin: top;
            transition: transform 0.3s ease;
            position: relative;
        }

        .rope.pulled {
            transform: rotate(15deg);
        }

        .rope-knob {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 16px;
            background: linear-gradient(to bottom, #d4a574, #8b4513);
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* GRID DISCOVERY STYLES - SMALLER PROFILES */
        .discovery-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        @media (max-width: 1200px) {
            .discovery-grid { grid-template-columns: repeat(4, 1fr); }
        }

        @media (max-width: 768px) {
            .discovery-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 480px) {
            .discovery-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .grid-profile-card {
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .grid-profile-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.2);
        }

        .grid-profile-image {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
        }

        .grid-profile-info {
            padding: 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        .grid-profile-actions {
            display: flex;
            gap: 5px;
            padding: 5px 8px;
            background: rgba(0,0,0,0.8);
        }

        .grid-action-btn {
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .grid-action-btn:hover {
            transform: scale(1.05);
        }

        .grid-action-btn.like { background: #22c55e; color: white; }
        .grid-action-btn.super { background: #3b82f6; color: white; }
        .grid-action-btn.pass { background: #ef4444; color: white; }

        /* SWIPE INTERFACE STYLES (REMOVED) */
        #swipe-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 60;
            background: #1a1a1a;
            flex-direction: column;
        }

        #swipe-interface.active {
            display: flex;
        }

        /* Matches Grid - SMALLER */
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        @media (max-width: 768px) {
            .matches-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .match-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 3/4;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .match-card:hover {
            transform: scale(1.03);
        }

        .match-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .match-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        /* Nearby Grid */
        .nearby-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .nearby-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nearby-card:hover {
            transform: scale(1.03);
        }

        .nearby-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nearby-distance {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #fbbf24;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
        }

        .nearby-online {
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            border: 2px solid #1a1a1a;
        }

        /* Chat Interface */
        .chat-list {
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .chat-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fbbf24;
        }

        .chat-preview {
            flex: 1;
        }

        .chat-name {
            font-weight: bold;
            color: white;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .chat-message {
            color: #888;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: #666;
            font-size: 11px;
        }

        .unread-badge {
            background: #ef4444;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* CHAT BOX */
        .chat-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .chat-box.active {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fbbf24;
            cursor: pointer;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .chat-header-status {
            font-size: 11px;
            color: #22c55e;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            animation: messageSlide 0.3s ease;
            font-size: 14px;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background: #fbbf24;
            color: black;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: rgba(255,255,255,0.1);
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 9px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .chat-input-area {
            padding: 12px 15px;
            background: rgba(0,0,0,0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            outline: none;
            font-size: 14px;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fbbf24;
            border: none;
            color: black;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        /* Profile Settings - COMPACT */
        .profile-header {
            position: relative;
            height: 150px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #fbbf24;
            object-fit: cover;
            position: absolute;
            bottom: -50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .avatar-upload-overlay {
            position: absolute;
            bottom: -50px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
            pointer-events: none;
        }

        .profile-header:hover .avatar-upload-overlay {
            opacity: 1;
            pointer-events: all;
        }

        .settings-section {
            padding: 70px 15px 80px;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .settings-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: #444;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #fbbf24;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .range-slider {
            width: 100%;
            margin: 8px 0;
        }

        .range-slider input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fbbf24;
            cursor: pointer;
        }

        .slider-value {
            color: #fbbf24;
            font-weight: bold;
            font-size: 13px;
        }

        .dual-range {
            position: relative;
            height: 35px;
        }

        .dual-range input[type="range"] {
            position: absolute;
            width: 100%;
            pointer-events: none;
            -webkit-appearance: none;
            background: none;
        }

        .dual-range input[type="range"]::-webkit-slider-thumb {
            pointer-events: all;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fbbf24;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px;
        }

        .dual-range input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
        }

        .editable-field {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            width: 100%;
            padding: 6px 0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .editable-field:focus {
            outline: none;
            border-bottom-color: #fbbf24;
        }

        .editable-field::placeholder {
            color: #666;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .photo-slot {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-slot:hover {
            transform: scale(1.05);
        }

        .photo-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-slot.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #666;
        }

        .photo-slot.empty:hover {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .delete-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .photo-slot:hover .delete-photo {
            opacity: 1;
        }

        .main-photo-badge {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: #fbbf24;
            color: black;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
        }

        .gender-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .gender-option {
            padding: 6px 12px;
            border-radius: 16px;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .gender-option:hover, .gender-option.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        /* PROFILE MENU STYLES */
        .profile-menu-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.5);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .profile-menu-btn:hover {
            background: rgba(251, 191, 36, 0.3);
        }

        .profile-dropdown {
            position: absolute;
            top: 55px;
            right: 15px;
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            min-width: 180px;
            overflow: hidden;
        }

        .profile-dropdown.active {
            display: block;
        }

        .profile-dropdown-item {
            padding: 12px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .profile-dropdown-item:hover {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .profile-dropdown-item i {
            width: 18px;
            text-align: center;
        }

        .profile-dropdown-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* PROFILE DETAIL MODAL - COMPACT */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 150;
            display: none;
            overflow-y: auto;
        }

        .profile-modal.active {
            display: block;
        }

        .profile-modal-header {
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .profile-modal-content {
            max-width: 400px;
            margin: 0 auto;
            padding: 0 15px 80px;
        }

        .profile-hero {
            position: relative;
            height: 350px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .profile-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-hero-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .gallery-photo {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .gallery-photo:hover img {
            transform: scale(1.1);
        }

        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-icon {
            width: 35px;
            height: 35px;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fbbf24;
            font-size: 14px;
        }

        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .action-bar-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }

        .action-bar-btn:hover {
            transform: scale(1.1);
        }

        .action-bar-btn.dislike { background: #ef4444; color: white; }
        .action-bar-btn.like { background: #22c55e; color: white; }
        .action-bar-btn.superlike { background: #3b82f6; color: white; }
        .action-bar-btn.message { background: #fbbf24; color: black; }

        /* NOTIFICATION PANEL STYLES */
        .notification-panel {
            position: fixed;
            top: 60px;
            right: 15px;
            width: 320px;
            max-width: 90vw;
            max-height: 450px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            z-index: 250;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .notification-panel.active {
            display: flex;
        }

        .notification-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        .notification-count {
            background: #ef4444;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .notification-list {
            overflow-y: auto;
            max-height: 350px;
            padding: 8px;
        }

        .notification-item {
            display: flex;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 6px;
        }

        .notification-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .notification-item.unread {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .notification-content {
            flex: 1;
        }

        .notification-text {
            color: white;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .notification-text strong {
            color: #fbbf24;
        }

        .notification-time {
            color: #888;
            font-size: 11px;
        }

        .notification-delete {
            color: #666;
            cursor: pointer;
            padding: 4px;
        }

        .notification-delete:hover {
            color: #ef4444;
        }

        .mark-all-read {
            padding: 12px;
            text-align: center;
            color: #fbbf24;
            cursor: pointer;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
        }

        .mark-all-read:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #22c55e;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
            font-size: 14px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Input Autofill Fix */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #1f1f1f inset !important;
            -webkit-text-fill-color: white !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }

        /* Hide sections by default */
        .app-section {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .app-section.active {
            display: block;
        }

        select {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
        }

        .phone-input {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 8px;
            color: white;
            width: 100%;
            font-size: 14px;
        }

        .phone-input:focus {
            outline: none;
            border-color: #fbbf24;
        }

        .nearby-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(251, 191, 36, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nearby-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* GROUP CHAT STYLES */
        .country-group {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            overflow: hidden;
        }

        .country-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.05));
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .country-header:hover {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.1));
        }

        .country-name {
            font-size: 16px;
            font-weight: bold;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .country-flag {
            font-size: 20px;
        }

        .room-count {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .rooms-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .rooms-container.expanded {
            max-height: 2000px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            padding: 12px;
        }

        .room-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .room-card:hover {
            background: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
            transform: translateY(-2px);
        }

        .room-name {
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .room-users {
            font-size: 10px;
            color: #888;
        }

        .online-dot {
            display: inline-block;
            width: 5px;
            height: 5px;
            background: #22c55e;
            border-radius: 50%;
            margin-right: 3px;
        }

        /* GROUP CHAT BOX STYLES */
        .group-chat-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .group-chat-box.active {
            display: flex;
        }

        .group-chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .group-chat-info {
            flex: 1;
        }

        .group-chat-name {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .group-chat-meta {
            font-size: 11px;
            color: #888;
        }

        .group-members-preview {
            display: flex;
            align-items: center;
        }

        .member-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #1a1a1a;
            margin-left: -8px;
            object-fit: cover;
        }

        .member-avatar:first-child {
            margin-left: 0;
        }

        .member-count {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            margin-left: -8px;
            border: 2px solid #1a1a1a;
        }

        /* AFRICAN MARKET ZONE STYLES */
        .market-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .market-categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .market-category {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 13px;
        }

        .market-category:hover, .market-category.active {
            background: #fbbf24;
            color: black;
            border-color: #fbbf24;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        @media (max-width: 768px) {
            .market-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .market-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .market-item:hover {
            transform: translateY(-3px);
            border-color: #fbbf24;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.2);
        }

        .market-item-image {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
        }

        .market-item-info {
            padding: 10px;
        }

        .market-item-title {
            font-weight: bold;
            color: white;
            margin-bottom: 3px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .market-item-price {
            color: #fbbf24;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .market-item-location {
            color: #888;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .market-item-seller {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .seller-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
        }

        .seller-name {
            color: #ccc;
            font-size: 12px;
        }

        .market-search {
            display: flex;
            gap: 8px;
            padding: 0 15px 12px;
        }

        .market-search input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            outline: none;
            font-size: 14px;
        }

        .market-sell-btn {
            padding: 10px 20px;
            border-radius: 20px;
            background: #fbbf24;
            color: black;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .market-sell-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
        }

        /* Market Item Detail Modal */
        .market-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 300;
            display: none;
            overflow-y: auto;
        }

        .market-detail-modal.active {
            display: block;
        }

        .market-detail-content {
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .market-detail-image {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
        }

        .market-detail-info {
            padding: 15px;
        }

        .market-detail-price {
            font-size: 24px;
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .market-detail-title {
            font-size: 20px;
            color: white;
            margin-bottom: 12px;
        }

        .market-detail-description {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .market-detail-meta {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .market-meta-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .market-meta-row:last-child {
            border-bottom: none;
        }

        .market-seller-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .market-seller-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .market-seller-info {
            flex: 1;
        }

        .market-seller-name {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .market-seller-rating {
            color: #fbbf24;
            font-size: 13px;
        }

        .market-contact-btn {
            width: 100%;
            background: #fbbf24;
            color: black;
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .market-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
        }

        /* CREATE ADVERT MODAL */
        .create-advert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 400;
            display: none;
            overflow-y: auto;
        }

        .create-advert-modal.active {
            display: block;
        }

        .create-advert-content {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
        }

        .create-advert-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: #fbbf24;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .image-upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.05);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .submit-advert-btn {
            width: 100%;
            background: #fbbf24;
            color: black;
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .submit-advert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
        }

        /* MAIN MENU STYLES */
        .main-menu-btn {
            position: fixed;
            top: 70px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #fbbf24, #d4af37);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 90;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            transition: all 0.3s;
        }

        .main-menu-btn:hover {
            transform: scale(1.1);
        }

        .main-menu-btn i {
            color: #1a1a1a;
            font-size: 20px;
        }

        .main-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 95;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .main-menu-overlay.active {
            display: block;
            opacity: 1;
        }

        .main-menu-panel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            max-width: 85vw;
            height: 100%;
            background: linear-gradient(180deg, #1a1a1a, #2a2a2a);
            z-index: 100;
            transition: right 0.3s ease;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.1);
        }

        .main-menu-panel.active {
            right: 0;
        }

        .main-menu-header {
            padding: 25px 15px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.05));
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .main-menu-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .main-menu-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #fbbf24;
            object-fit: cover;
        }

        .main-menu-user-info h3 {
            color: white;
            font-size: 18px;
            margin-bottom: 3px;
        }

        .main-menu-user-info p {
            color: #888;
            font-size: 13px;
        }

        .main-menu-items {
            padding: 15px;
        }

        .main-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 10px;
            margin-bottom: 4px;
        }

        .main-menu-item:hover {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .main-menu-item i {
            width: 25px;
            text-align: center;
            font-size: 18px;
        }

        .main-menu-item span {
            font-size: 15px;
        }

        .main-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 12px 0;
        }

        .main-menu-section-title {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px 8px;
            margin-top: 8px;
        }

        /* Bottom Nav */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .nav-item {
            color: #666;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            font-size: 10px;
        }

        .nav-item:hover, .nav-item.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            margin-top: auto;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.rewind { background: #fbbf24; }
        .action-btn.nope { background: #ef4444; }
        .action-btn.superlike { background: #3b82f6; }
        .action-btn.like { background: #22c55e; }
        .action-btn.boost { background: #a855f7; }

        /* Verification Badge - ONLY FOR SPECIFIC USERS */
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 6px;
        }

        /* My Adverts Section */
        .my-adverts-section {
            padding: 15px;
        }

        .my-advert-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .my-advert-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
        }

        .my-advert-info {
            padding: 12px;
        }

        .my-advert-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .delete-advert-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .delete-advert-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* ENIOLA BOT STYLES - MINIMAL */
        .eniola-bot {
            position: fixed;
            bottom: 90px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 85;
            opacity: 0.6;
            transition: all 0.3s;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .eniola-bot:hover {
            opacity: 1;
            transform: scale(1.1);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.5), rgba(251, 191, 36, 0.2));
        }

        .eniola-bot i {
            color: #fbbf24;
            font-size: 24px;
        }

        .eniola-chat {
            position: fixed;
            bottom: 150px;
            right: 15px;
            width: 280px;
            max-width: 85vw;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 86;
            display: none;
            flex-direction: column;
            overflow: hidden;
            opacity: 0.9;
        }

        .eniola-chat.active {
            display: flex;
        }

        .eniola-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.05));
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .eniola-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .eniola-name {
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .eniola-status {
            color: #22c55e;
            font-size: 11px;
        }

        .eniola-messages {
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .eniola-message {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            color: white;
            font-size: 12px;
            line-height: 1.4;
        }

        .eniola-options {
            padding: 0 12px 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .eniola-option {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 6px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .eniola-option:hover {
            background: rgba(251, 191, 36, 0.2);
        }

        .eniola-close {
            position: absolute;
            top: 12px;
            right: 12px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        /* Logo with Africa Image */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fbbf24;
        }

        /* Auth Form Styles - Simplified */
        .auth-container {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        .auth-title {
            text-align: center;
            color: #fbbf24;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            font-family: 'Playfair Display', serif;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
        }

        .auth-tab.active {
            color: #fbbf24;
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #fbbf24;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #aaa;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #fbbf24;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group input::placeholder {
            color: #666;
        }

        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #fbbf24, #d4af37);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(251, 191, 36, 0.3);
        }

        .auth-error {
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        .auth-success {
            color: #22c55e;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        /* Search Bar Styles */
        .search-container {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 8px 15px;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: #666;
        }

        .search-results {
            position: absolute;
            top: 110px;
            left: 15px;
            right: 15px;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .search-result-item:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .search-result-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .search-result-meta {
            color: #888;
            font-size: 12px;
        }

        .add-friend-btn {
            background: #fbbf24;
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-friend-btn:hover {
            transform: scale(1.05);
        }

        .add-friend-btn.added {
            background: #22c55e;
            color: white;
        }

        /* Offline Overlay */
        .offline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .offline-overlay.active {
            display: flex;
        }

        .offline-icon {
            font-size: 60px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .offline-text {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .offline-subtext {
            color: #888;
            font-size: 16px;
        }
    </style>
<base target="_blank">
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase, ref, push, onValue, set, get, update, remove, query, orderByChild, limitToLast, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ============================================
      // FIREBASE CONFIG - Using AfriConnect project
      // ============================================
      const firebaseConfig = {
        apiKey: "AIzaSyAC-xvFTIF-Tw4w5AoJAZdDZkpTuIygqwY",
        authDomain: "africonnect-50b9f.firebaseapp.com",
        databaseURL: "https://africonnect-50b9f-default-rtdb.firebaseio.com",
        projectId: "africonnect-50b9f",
        storageBucket: "africonnect-50b9f.appspot.com",
        messagingSenderId: "000000000000",
        appId: "1:000000000000:web:0000000000000000"
      };

      // AfriConnect Firebase project - africonnect-50b9f
      // NOTE: If messagingSenderId or appId are needed, add them from your Firebase console  Project Settings

      let firebaseApp, firebaseAuth, firebaseDb;
      let firebaseReady = false;

      try {
        firebaseApp = initializeApp(firebaseConfig);
        firebaseAuth = getAuth(firebaseApp);
        firebaseDb = getDatabase(firebaseApp);
        firebaseReady = true;
        console.log("Firebase initialized");
      } catch (e) {
        console.warn("Firebase init failed, using localStorage fallback:", e.message);
      }

      // Expose to global scope for use in main scripts
      window._firebase = {
        auth: firebaseAuth,
        db: firebaseDb,
        ready: firebaseReady,
        push, ref, onValue, set, get, update, remove, query, orderByChild, limitToLast, onChildAdded,
        createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
      };

      // ============================================
      // REAL-TIME MESSAGE LISTENERS
      // ============================================
      
      window._fbListeners = {};

      window._listenToConversation = function(conversationId, callback) {
        if (!firebaseReady || !firebaseDb) return;
        const key = `conversation_${conversationId}`;
        if (window._fbListeners[key]) return; // Already listening
        
        const msgsRef = ref(firebaseDb, `messages/${conversationId}`);
        const unsubscribe = onChildAdded(msgsRef, (snapshot) => {
          const msg = snapshot.val();
          if (msg) callback(msg, snapshot.key);
        });
        window._fbListeners[key] = unsubscribe;
      };

      window._stopListening = function(conversationId) {
        const key = `conversation_${conversationId}`;
        if (window._fbListeners[key]) {
          window._fbListeners[key](); // Call unsubscribe
          delete window._fbListeners[key];
        }
      };

      window._sendFirebaseMessage = async function(conversationId, message) {
        if (!firebaseReady || !firebaseDb) return false;
        try {
          const msgsRef = ref(firebaseDb, `messages/${conversationId}`);
          await push(msgsRef, message);
          return true;
        } catch (e) {
          console.warn("Firebase send failed:", e.message);
          return false;
        }
      };

      window._sendGroupFirebaseMessage = async function(roomId, message) {
        if (!firebaseReady || !firebaseDb) return false;
        try {
          const msgsRef = ref(firebaseDb, `groupMessages/${roomId}`);
          await push(msgsRef, message);
          return true;
        } catch (e) {
          console.warn("Firebase group send failed:", e.message);
          return false;
        }
      };

      window._listenToGroupChat = function(roomId, callback) {
        if (!firebaseReady || !firebaseDb) return;
        const key = `group_${roomId}`;
        if (window._fbListeners[key]) return;
        
        const msgsRef = ref(firebaseDb, `groupMessages/${roomId}`);
        const unsubscribe = onChildAdded(msgsRef, (snapshot) => {
          const msg = snapshot.val();
          if (msg) callback(msg, snapshot.key);
        });
        window._fbListeners[key] = unsubscribe;
      };

      // ============================================
      // FIREBASE AUTH HELPERS
      // ============================================

      window._firebaseLogin = async function(email, password) {
        if (!firebaseReady || !firebaseAuth) return { success: false, error: "Firebase not available" };
        try {
          const cred = await signInWithEmailAndPassword(firebaseAuth, email, password);
          return { success: true, user: cred.user };
        } catch (e) {
          return { success: false, error: e.message };
        }
      };

      window._firebaseSignup = async function(email, password) {
        if (!firebaseReady || !firebaseAuth) return { success: false, error: "Firebase not available" };
        try {
          const cred = await createUserWithEmailAndPassword(firebaseAuth, email, password);
          return { success: true, user: cred.user };
        } catch (e) {
          return { success: false, error: e.message };
        }
      };

      window._firebaseLogout = async function() {
        if (!firebaseReady || !firebaseAuth) return;
        try { await signOut(firebaseAuth); } catch (e) {}
      };

      // ============================================
      // ADMIN PANEL - Firebase data access
      // ============================================
      
      window._adminGetAllUsers = async function() {
        if (!firebaseReady || !firebaseDb) {
          // Fallback to localStorage
          return JSON.parse(localStorage.getItem('afriConnect_users')) || {};
        }
        try {
          const snapshot = await get(ref(firebaseDb, 'users'));
          return snapshot.val() || {};
        } catch (e) {
          return JSON.parse(localStorage.getItem('afriConnect_users')) || {};
        }
      };

      window._adminGetAllMessages = async function() {
        if (!firebaseReady || !firebaseDb) return {};
        try {
          const snapshot = await get(ref(firebaseDb, 'messages'));
          return snapshot.val() || {};
        } catch (e) { return {}; }
      };

      window._adminDeleteUser = async function(username) {
        if (!firebaseReady || !firebaseDb) {
          const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
          delete users[username];
          localStorage.setItem('afriConnect_users', JSON.stringify(users));
          return true;
        }
        try {
          await remove(ref(firebaseDb, `users/${username}`));
          return true;
        } catch (e) { return false; }
      };

      window._adminSaveUserToDB = async function(username, userData) {
        if (!firebaseReady || !firebaseDb) return;
        try {
          await set(ref(firebaseDb, `users/${username}`), userData);
        } catch (e) {}
      };

      window._adminGetStats = async function() {
        const users = await window._adminGetAllUsers();
        const msgs = await window._adminGetAllMessages();
        
        const totalUsers = Object.keys(users).length;
        const totalMsgConvs = Object.keys(msgs).length;
        let totalMsgCount = 0;
        Object.values(msgs).forEach(conv => {
          totalMsgCount += Object.keys(conv || {}).length;
        });
        
        return { totalUsers, totalMsgConvs, totalMsgCount };
      };

      console.log("AfriConnect Firebase module loaded");
    </script>
</head>
<body class="text-gray-200 font-sans min-h-screen flex flex-col relative">

    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay">
        <div class="offline-icon">
            <i class="fas fa-wifi"></i>
        </div>
        <div class="offline-text">You are offline</div>
        <div class="offline-subtext">Please check your internet connection and try again</div>
    </div>

    <!-- Africa Map Background -->
    <div class="africa-map-bg" id="africaMapBg"></div>

    <!-- Square Column Table Lamp -->
    <div class="lamp-container" id="touchLamp" title="Pull rope to toggle light">
        <!-- Lamp Shade -->
        <div class="lamp-shade-square">
            <div class="bulb-glow"></div>
        </div>
        
        <!-- Column Body -->
        <div class="lamp-column">
            <div class="lamp-inner-light"></div>
        </div>
        
        <!-- Base -->
        <div class="lamp-base-square"></div>
        
        <!-- Rope Switch -->
        <div class="rope-switch-container">
            <div class="rope-base"></div>
            <div class="rope" id="ropeSwitch">
                <div class="rope-knob"></div>
            </div>
        </div>
    </div>

    <div id="lamp-light"></div>
    <div id="darkness-overlay"></div>

    <!-- Dark Welcome -->
    <div id="dark-welcome">
        <div class="text-center space-y-6 p-6">
            <h1 class="text-5xl md:text-7xl font-serif font-bold glow-text tracking-widest uppercase">Welcome</h1>
            <p class="text-lg md:text-xl font-light text-gray-500 tracking-wide max-w-md mx-auto leading-relaxed">
                It is dark in here.<br>
                <span class="text-yellow-700 font-semibold">Pull the rope switch</span> to illuminate your journey.
            </p>
        </div>
    </div>

    <!-- Auth Interface - Simplified -->
    <div id="interface-container" class="relative z-20 flex-grow flex items-center justify-center p-4">
        <div class="auth-container">
            <div class="auth-title">AfriConnect</div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="auth-btn">ENTER THE LIGHT</button>
                <div class="auth-error" id="loginError"></div>
            </form>

            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="signupUsername" placeholder="Choose a username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password" required autocomplete="new-password">
                </div>
                <button type="submit" class="auth-btn">BEGIN JOURNEY</button>
                <div class="auth-error" id="signupError"></div>
                <div class="auth-success" id="signupSuccess"></div>
            </form>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="swipe-interface">
        <!-- Top Bar -->
        <div class="flex justify-between items-center p-4 bg-black/50 backdrop-blur-sm border-b border-white/10">
            <div class="logo-container">
                <img src="https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg" class="logo-image" style="width: 32px; height: 32px;" alt="AfriConnect Logo">
                <span class="font-serif font-bold text-yellow-500 text-lg">AfriConnect</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleNotifications()" class="relative text-gray-400 hover:text-white">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notifBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center hidden">0</span>
                </button>
                <button onclick="logout()" class="text-sm text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Search Container -->
        <div class="search-container">
            <div class="search-bar">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" id="userSearchInput" placeholder="Search for users to add as friends..." onkeyup="searchUsers(this.value)">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- NOTIFICATION PANEL -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <span class="notification-title">Notifications</span>
                <span class="notification-count" id="notifCount">0 new</span>
            </div>
            <div class="notification-list" id="notificationList"></div>
            <div class="mark-all-read" onclick="markAllNotificationsRead()">
                Mark all as read
            </div>
        </div>

        <!-- MAIN MENU BUTTON -->
        <div class="main-menu-btn" onclick="toggleMainMenu()">
            <i class="fas fa-bars"></i>
        </div>

        <!-- MAIN MENU OVERLAY -->
        <div class="main-menu-overlay" id="mainMenuOverlay" onclick="toggleMainMenu()"></div>

        <!-- MAIN MENU PANEL -->
        <div class="main-menu-panel" id="mainMenuPanel">
            <div class="main-menu-header">
                <div class="main-menu-user">
                    <img src="" class="main-menu-avatar" id="menuUserAvatar" alt="User">
                    <div class="main-menu-user-info">
                        <h3 id="menuUserName">User</h3>
                        <p>Member</p>
                    </div>
                </div>
            </div>
            
            <div class="main-menu-items">
                <div class="main-menu-section-title">Menu</div>
                
                <div class="main-menu-item" onclick="showSectionFromMenu('market')">
                    <i class="fas fa-store"></i>
                    <span>African Market Zone</span>
                </div>
                
                <div class="main-menu-item" onclick="showSectionFromMenu('nearby')">
                    <i class="fas fa-bolt"></i>
                    <span>FLASH</span>
                </div>
                
                <div class="main-menu-item" onclick="showSectionFromMenu('profile')">
                    <i class="fas fa-user"></i>
                    <span>My Profile</span>
                </div>

                <div class="main-menu-divider"></div>
                
                <div class="main-menu-section-title">Market</div>
                
                <div class="main-menu-item" onclick="showMyAdverts()">
                    <i class="fas fa-bullhorn"></i>
                    <span>My Adverts</span>
                </div>
                
                <div class="main-menu-item" onclick="openCreateAdvert()">
                    <i class="fas fa-plus-circle"></i>
                    <span>Create Advert</span>
                </div>

                <div class="main-menu-divider"></div>
                
                <div class="main-menu-section-title">Appearance</div>
                
                <!-- Dark / Light Mode Toggle -->
                <div class="main-menu-item" onclick="toggleDarkLight()" id="darkLightMenuItem">
                    <i class="fas fa-moon" id="darkLightIcon"></i>
                    <span id="darkLightLabel">Dark Mode</span>
                    <div id="darkLightToggle" class="toggle-switch active" style="margin-left:auto;pointer-events:none;"></div>
                </div>

                <!-- Desktop / Mobile Mode Toggle -->
                <div class="main-menu-item" onclick="toggleDesktopMode()" id="desktopModeMenuItem">
                    <i class="fas fa-desktop" id="desktopModeIcon"></i>
                    <span id="desktopModeLabel">Desktop Mode</span>
                    <div id="desktopModeToggle" class="toggle-switch" style="margin-left:auto;pointer-events:none;"></div>
                </div>

                <div class="main-menu-divider"></div>
                
                <!-- Install App Button -->
                <div style="padding: 8px 12px;">
                    <button class="install-btn" id="installAppBtn" onclick="installApp()" disabled>
                        <i class="fas fa-download"></i>
                        <span id="installBtnText">Add to Home Screen</span>
                    </button>
                </div>

                <div class="main-menu-divider"></div>
                
                <div class="main-menu-section-title">Support</div>
                
                <div class="main-menu-item" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </div>
                
                <div class="main-menu-item" onclick="openAdminPanel()" style="background: rgba(251,191,36,0.05); border: 1px solid rgba(251,191,36,0.15); border-radius: 10px; margin-top: 4px;">
                    <i class="fas fa-shield-alt" style="color: #fbbf24;"></i>
                    <span style="color: #fbbf24;">Backend Panel</span>
                </div>
                
                <div class="main-menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt" style="color: #ef4444;"></i>
                    <span style="color: #ef4444;">Logout</span>
                </div>
            </div>
        </div>

        <!-- ENIOLA BOT - MINIMAL -->
        <div class="eniola-bot" onclick="toggleEniola()" title="Chat with ENIOLA">
            <i class="fas fa-robot"></i>
        </div>

        <!-- FLASH CREATE BUTTON -->
        <button class="flash-create-btn" id="flashCreateBtn" onclick="openFlashCreate()" title="Post a Flash">
            <i class="fas fa-bolt"></i>
        </button>

        <!-- ENIOLA CHAT -->
        <div class="eniola-chat" id="eniolaChat">
            <div class="eniola-header">
                <div class="eniola-avatar"></div>
                <div>
                    <div class="eniola-name">ENIOLA</div>
                    <div class="eniola-status"> Online</div>
                </div>
                <i class="fas fa-times eniola-close" onclick="toggleEniola()"></i>
            </div>
            <div class="eniola-messages" id="eniolaMessages">
                <div class="eniola-message">
                    Hello! I'm ENIOLA, your AfriConnect assistant. Welcome! How can I help you today?
                </div>
            </div>
            <div class="eniola-options" id="eniolaOptions">
                <div class="eniola-option" onclick="askEniola('how')">How does this work?</div>
                <div class="eniola-option" onclick="askEniola('discover')">How to find matches?</div>
                <div class="eniola-option" onclick="askEniola('market')">About Marketplace</div>
                <div class="eniola-option" onclick="askEniola('groups')">Community Groups</div>
                <div class="eniola-option" onclick="askEniola('safety')">Safety Tips</div>
            </div>
        </div>

        <!-- DISCOVERY SECTION - GRID VIEW -->
        <div id="section-swipe" class="app-section active">
            <div class="p-3 border-b border-white/10 flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold text-white">Discover</h2>
                    <p class="text-xs text-gray-400">Find your perfect match</p>
                </div>
                <select onchange="filterDiscovery(this.value)" class="text-xs">
                    <option value="all">All</option>
                    <option value="male">Men</option>
                    <option value="female">Women</option>
                    <option value="verified">Verified Only</option>
                </select>
            </div>
            <div class="discovery-grid" id="discoveryGrid"></div>
        </div>

        <!-- FLASH SECTION (replaces Nearby) -->
        <div id="section-nearby" class="app-section">
            <div style="padding:12px 15px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2 style="font-size:20px;font-weight:bold;color:#fbbf24;font-family:'Playfair Display',serif;display:flex;align-items:center;gap:8px;">
                        <i class="fas fa-bolt"></i> FLASH
                    </h2>
                    <p style="font-size:11px;color:#888;">Posts vanish after 48 hours </p>
                </div>
                <div class="flash-timer-badge">
                    <i class="fas fa-clock"></i> 48hr posts
                </div>
            </div>
            <div class="flash-feed" id="flashFeed">
                <!-- Flash posts injected here -->
            </div>
        </div>

        <!-- GROUP CHAT SECTION -->
        <div id="section-groups" class="app-section">
            <div class="p-3 border-b border-white/10">
                <h2 class="text-lg font-bold text-white">African Community Groups</h2>
                <p class="text-xs text-gray-400">Join chat rooms by country & region</p>
            </div>
            <div class="p-3" id="groupsContainer"></div>
        </div>

        <!-- MATCHES SECTION -->
        <div id="section-matches" class="app-section">
            <div class="p-3 border-b border-white/10">
                <h2 class="text-lg font-bold text-white">Your Matches</h2>
                <p class="text-xs text-gray-400">People you matched with</p>
            </div>
            <div class="matches-grid" id="matchesGrid"></div>
        </div>

        <!-- MESSAGES SECTION -->
        <div id="section-messages" class="app-section">
            <div class="p-3 border-b border-white/10">
                <h2 class="text-lg font-bold text-white">Messages</h2>
            </div>
            <div class="chat-list" id="chatList"></div>
        </div>

        <!-- AFRICAN MARKET ZONE SECTION -->
        <div id="section-market" class="app-section">
            <div class="market-header">
                <h2 class="text-xl font-bold text-yellow-500">African Market Zone</h2>
                <p class="text-xs text-gray-400">Buy, sell & connect with African vendors</p>
            </div>
            
            <div class="market-search">
                <input type="text" placeholder="Search products, services..." id="marketSearch" onkeyup="searchMarket(this.value)">
                <button class="market-sell-btn" onclick="openCreateAdvert()">
                    <i class="fas fa-plus"></i> Sell
                </button>
            </div>

            <div class="market-categories">
                <div class="market-category active" onclick="filterMarket('all', this)">All Items</div>
                <div class="market-category" onclick="filterMarket('fashion', this)">Fashion</div>
                <div class="market-category" onclick="filterMarket('art', this)">Art & Crafts</div>
                <div class="market-category" onclick="filterMarket('beauty', this)">Beauty</div>
                <div class="market-category" onclick="filterMarket('tech', this)">Tech</div>
                <div class="market-category" onclick="filterMarket('services', this)">Services</div>
            </div>

            <div class="market-grid" id="marketGrid"></div>
        </div>

        <!-- MY ADVERTS SECTION -->
        <div id="section-myadverts" class="app-section">
            <div class="p-3 border-b border-white/10 flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold text-white">My Adverts</h2>
                    <p class="text-xs text-gray-400">Manage your listings</p>
                </div>
                <button class="market-sell-btn" onclick="openCreateAdvert()" style="padding: 8px 16px; font-size: 13px;">
                    <i class="fas fa-plus"></i> New
                </button>
            </div>
            <div class="my-adverts-section" id="myAdvertsContainer">
                <p style="text-align: center; color: #888; padding: 40px;">You haven't created any adverts yet.</p>
            </div>
        </div>

        <!-- PROFILE SETTINGS SECTION -->
        <div id="section-profile" class="app-section">
            <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">

            <div class="profile-header">
                <div class="profile-menu-btn" onclick="toggleProfileMenu()">
                    <i class="fas fa-ellipsis-v text-white"></i>
                </div>
                
                <!-- Profile Dropdown Menu -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-item" onclick="showSection('profile'); toggleProfileMenu();">
                        <i class="fas fa-user"></i>
                        <span>View Profile</span>
                    </div>
                    <div class="profile-dropdown-item" onclick="showProfileSettings(); toggleProfileMenu();">
                        <i class="fas fa-cog"></i>
                        <span>Profile Settings</span>
                    </div>
                    <div class="profile-dropdown-item" onclick="showPrivacySettings(); toggleProfileMenu();">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy & Safety</span>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <div class="profile-dropdown-item" onclick="showHelp(); toggleProfileMenu();">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </div>
                    <div class="profile-dropdown-item" onclick="showAbout(); toggleProfileMenu();">
                        <i class="fas fa-info-circle"></i>
                        <span>About AfriConnect</span>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <div class="profile-dropdown-item" onclick="logout(); toggleProfileMenu();" style="color: #ef4444;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>

                <img src="" class="profile-avatar-large" id="userAvatar" onclick="document.getElementById('avatarUpload').click()">
                <div class="avatar-upload-overlay" onclick="document.getElementById('avatarUpload').click()">
                    <i class="fas fa-camera text-2xl text-white"></i>
                </div>
                <button class="absolute top-4 left-4 bg-black/50 p-2 rounded-full hover:bg-yellow-600 transition-colors" onclick="document.getElementById('photoUpload').click()">
                    <i class="fas fa-plus text-white text-sm"></i>
                </button>
            </div>
            
            <div class="settings-section" id="profileSettingsSection">
                <!-- Basic Info -->
                <div class="settings-card">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base font-bold text-yellow-500">About Me</h3>
                        <button onclick="saveProfile()" class="text-xs text-yellow-500 hover:text-yellow-400">
                            <i class="fas fa-check mr-1"></i>Save
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Name</label>
                        <input type="text" id="profileName" class="editable-field" placeholder="Your name">
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Age</label>
                        <input type="number" id="profileAge" class="editable-field" placeholder="Your age">
                    </div>

                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Bio</label>
                        <textarea id="profileBio" class="editable-field w-full bg-transparent resize-none" rows="2" placeholder="Tell us about yourself..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Job Title</label>
                        <input type="text" id="profileJob" class="editable-field" placeholder="Your job">
                    </div>

                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Company</label>
                        <input type="text" id="profileCompany" class="editable-field" placeholder="Your company">
                    </div>

                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">School</label>
                        <input type="text" id="profileSchool" class="editable-field" placeholder="Your school">
                    </div>

                    <!-- Phone Number -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 uppercase tracking-wider">Phone Number</label>
                        <div class="flex gap-2 mt-2">
                            <select class="bg-transparent border border-gray-700 rounded-lg px-2 py-2 text-white text-xs" style="width: 70px;">
                                <option value="+234"> +234</option>
                                <option value="+233"> +233</option>
                                <option value="+254"> +254</option>
                                <option value="+27"> +27</option>
                                <option value="+255"> +255</option>
                            </select>
                            <input type="tel" id="profilePhone" class="phone-input flex-1 text-sm" placeholder="801 234 5678">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Phone is only shown to mutual matches</p>
                    </div>
                </div>

                <!-- Photo Manager -->
                <div class="settings-card">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Photos</h3>
                    <p class="text-xs text-gray-400 mb-2">Tap + to add, tap  to remove. First photo is your main photo.</p>
                    <div class="photo-grid" id="photoGrid"></div>
                </div>

                <!-- Gender & Orientation -->
                <div class="settings-card">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Gender</h3>
                    <div class="gender-options" id="genderOptions">
                        <div class="gender-option selected" onclick="selectGender(this, 'woman')">Woman</div>
                        <div class="gender-option" onclick="selectGender(this, 'man')">Man</div>
                        <div class="gender-option" onclick="selectGender(this, 'non-binary')">Non-binary</div>
                    </div>

                    <h3 class="text-base font-bold text-yellow-500 mb-3 mt-4">Show Me</h3>
                    <div class="setting-item">
                        <span class="text-sm">Looking for</span>
                        <select id="lookingFor" onchange="updateSetting('lookingFor', this.value)" class="text-xs">
                            <option value="men">Men</option>
                            <option value="women">Women</option>
                            <option value="everyone" selected>Everyone</option>
                        </select>
                    </div>
                </div>

                <!-- Discovery Settings -->
                <div class="settings-card">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Discovery Settings</h3>
                    
                    <div class="setting-item flex-col items-start gap-2">
                        <div class="flex justify-between w-full">
                            <span class="text-sm">Maximum Distance</span>
                            <span class="slider-value" id="distanceValue">50 km</span>
                        </div>
                        <div class="range-slider">
                            <input type="range" min="1" max="100" value="50" id="distanceSlider" oninput="updateDistance(this.value)">
                        </div>
                    </div>

                    <div class="setting-item flex-col items-start gap-2">
                        <div class="flex justify-between w-full">
                            <span class="text-sm">Age Range</span>
                            <span class="slider-value" id="ageValue">22 - 30</span>
                        </div>
                        <div class="dual-range">
                            <input type="range" min="18" max="80" value="22" id="ageMin" oninput="updateAgeRange()">
                            <input type="range" min="18" max="80" value="30" id="ageMax" oninput="updateAgeRange()">
                        </div>
                    </div>

                    <div class="setting-item mt-3">
                        <span class="text-sm">Show me on AfriConnect</span>
                        <div class="toggle-switch active" id="showMeToggle" onclick="this.classList.toggle('active')"></div>
                    </div>

                    <div class="setting-item">
                        <span class="text-sm">Appear in Nearby</span>
                        <div class="toggle-switch active" id="nearbyToggle" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="settings-card">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Notifications</h3>
                    <div class="setting-item">
                        <span class="text-sm">New Matches</span>
                        <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                    </div>
                    <div class="setting-item">
                        <span class="text-sm">Messages</span>
                        <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                    </div>
                    <div class="setting-item">
                        <span class="text-sm">Push Notifications</span>
                        <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>

                <!-- Account -->
                <div class="settings-card">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Account</h3>
                    <div class="setting-item cursor-pointer" onclick="logout()">
                        <span class="text-red-400 text-sm">Logout</span>
                        <i class="fas fa-sign-out-alt text-red-400"></i>
                    </div>
                    <div class="setting-item cursor-pointer">
                        <span class="text-red-400 text-sm">Delete Account</span>
                        <i class="fas fa-trash text-red-400"></i>
                    </div>
                </div>

                <div class="h-16"></div>
            </div>
        </div>

        <!-- Bottom Navigation - Simplified -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showSection('swipe')">
                <i class="fas fa-fire text-lg"></i>
                <span>Discover</span>
            </div>
            <div class="nav-item" onclick="showSection('nearby')">
                <i class="fas fa-bolt text-lg"></i>
                <span>FLASH</span>
            </div>
            <div class="nav-item" onclick="showSection('matches')">
                <i class="fas fa-heart text-lg"></i>
                <span>Matches</span>
            </div>
            <div class="nav-item" onclick="showSection('messages')">
                <i class="fas fa-comment text-lg"></i>
                <span>Messages</span>
            </div>
        </div>
    </div>

    <!-- CHAT BOX -->
    <div class="chat-box" id="chatBox">
        <div class="chat-header">
            <button onclick="closeChat()" class="text-white hover:text-yellow-400">
                <i class="fas fa-arrow-left text-lg"></i>
            </button>
            <img src="" class="chat-header-avatar" id="chatAvatar" onclick="viewProfileFromChat()">
            <div class="chat-header-info">
                <div class="chat-header-name" id="chatName"></div>
                <div class="chat-header-status" id="chatStatus">Online</div>
            </div>
            <button onclick="viewProfileFromChat()" class="text-gray-400 hover:text-white">
                <i class="fas fa-info-circle text-lg"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <button class="text-gray-400 hover:text-yellow-400 text-lg">
                <i class="fas fa-plus-circle"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- GROUP CHAT BOX -->
    <div class="group-chat-box" id="groupChatBox">
        <div class="group-chat-header">
            <button onclick="closeGroupChat()" class="text-white hover:text-yellow-400">
                <i class="fas fa-arrow-left text-lg"></i>
            </button>
            <div class="group-chat-info">
                <div class="group-chat-name" id="groupChatName"></div>
                <div class="group-chat-meta" id="groupChatMeta">Community Chat Room</div>
            </div>
            <div class="group-members-preview" id="groupMembersPreview"></div>
        </div>
        <div class="chat-messages" id="groupChatMessages"></div>
        <div class="chat-input-area">
            <button class="text-gray-400 hover:text-yellow-400 text-lg">
                <i class="fas fa-plus-circle"></i>
            </button>
            <input type="text" class="chat-input" id="groupChatInput" placeholder="Type a message..." onkeypress="handleGroupChatKeypress(event)">
            <button class="chat-send-btn" onclick="sendGroupMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- MARKET ITEM DETAIL MODAL -->
    <div class="market-detail-modal" id="marketDetailModal">
        <div class="market-detail-content">
            <div class="profile-modal-header">
                <button onclick="closeMarketDetail()" class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <div class="flex gap-2">
                    <button class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </div>
            <div id="marketDetailContent"></div>
        </div>
    </div>

    <!-- FLASH CREATE MODAL -->
    <div class="flash-create-modal" id="flashCreateModal">
        <div class="flash-create-content">
            <div style="display:flex;align-items:center;gap:12px;padding:15px 0;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px;">
                <button onclick="closeFlashCreate()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 style="color:#fbbf24;font-size:18px;font-family:'Playfair Display',serif;"><i class="fas fa-bolt"></i> Post a Flash</h2>
            </div>

            <div class="flash-timer-badge" style="margin-bottom:16px;">
                <i class="fas fa-clock"></i> This post will automatically delete after <strong>48 hours</strong>
            </div>

            <div class="flash-upload-area" onclick="document.getElementById('flashImageInput').click()" id="flashUploadArea">
                <i class="fas fa-camera" style="font-size:32px;color:#888;display:block;margin-bottom:10px;"></i>
                <p style="color:#888;font-size:14px;">Tap to add a photo</p>
                <p style="color:#555;font-size:12px;margin-top:4px;">JPG, PNG or GIF</p>
            </div>
            <input type="file" id="flashImageInput" accept="image/*" style="display:none;" onchange="previewFlashImage(event)">
            <div id="flashImagePreview" style="display:none;margin-bottom:16px;border-radius:12px;overflow:hidden;">
                <img id="flashPreviewImg" style="width:100%;max-height:300px;object-fit:cover;">
                <button onclick="clearFlashImage()" style="width:100%;background:rgba(239,68,68,0.2);color:#f87171;border:none;padding:8px;cursor:pointer;font-size:12px;">
                    <i class="fas fa-times"></i> Remove Image
                </button>
            </div>

            <div style="margin-bottom:16px;">
                <label style="color:#fbbf24;font-size:13px;font-weight:bold;display:block;margin-bottom:6px;">Caption (optional)</label>
                <textarea id="flashCaption" placeholder="What's happening? Share with the community..." style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:12px;color:white;font-size:14px;resize:vertical;min-height:80px;outline:none;" onfocus="this.style.borderColor='#fbbf24'" onblur="this.style.borderColor='rgba(255,255,255,0.15)'"></textarea>
            </div>

            <button onclick="submitFlashPost()" style="width:100%;background:linear-gradient(135deg,#fbbf24,#d4af37);color:black;border:none;border-radius:12px;padding:15px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                <i class="fas fa-bolt"></i> Post Flash (48hrs)
            </button>
        </div>
    </div>
    <div class="create-advert-modal" id="createAdvertModal">
        <div class="create-advert-content">
            <div class="create-advert-header">
                <button onclick="closeCreateAdvert()" class="text-white hover:text-yellow-400">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="text-lg font-bold text-white">Create Advert</h2>
            </div>

            <form id="advertForm" onsubmit="submitAdvert(event)">
                <div class="form-group">
                    <label class="form-label">Product Photos</label>
                    <div class="image-upload-area" onclick="document.getElementById('advertImageInput').click()">
                        <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                        <p style="color: #888; font-size: 13px;">Click to upload photos</p>
                        <p style="color: #666; font-size: 11px; margin-top: 3px;">You can add up to 5 photos</p>
                    </div>
                    <input type="file" id="advertImageInput" accept="image/*" multiple style="display: none;" onchange="previewAdvertImages(event)">
                    <div id="advertImagePreview" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="advertTitle" placeholder="What are you selling?" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="advertCategory" required>
                        <option value="">Select category</option>
                        <option value="fashion">Fashion</option>
                        <option value="art">Art & Crafts</option>
                        <option value="beauty">Beauty</option>
                        <option value="tech">Tech</option>
                        <option value="services">Services</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Price</label>
                    <input type="text" class="form-input" id="advertPrice" placeholder="e.g. 25,000" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="advertLocation" placeholder="e.g. Lagos, Nigeria" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="advertCondition" required>
                        <option value="New">New</option>
                        <option value="Used - Like New">Used - Like New</option>
                        <option value="Used - Good">Used - Good</option>
                        <option value="Used - Fair">Used - Fair</option>
                        <option value="Service">Service</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="advertDescription" placeholder="Describe your product or service..." required></textarea>
                </div>

                <button type="submit" class="submit-advert-btn">
                    <i class="fas fa-check"></i> Post Advert
                </button>
            </form>
        </div>
    </div>

    <!-- PROFILE DETAIL MODAL -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-header">
            <button onclick="closeProfileModal()" class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                <i class="fas fa-arrow-down"></i>
            </button>
            <div class="flex gap-2">
                <button class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="profile-modal-content" id="profileModalContent"></div>

        <div class="action-bar" id="profileModalActions"></div>
    </div>

    <!-- Notification Toast -->
    <div class="toast" id="toast">It's a Match! </div>

    <!-- ============================================ -->
    <!-- ADMIN PANEL - PASSWORD PROTECTED             -->
    <!-- ============================================ -->

    <!-- Admin Lock Screen -->
    <div id="adminLockScreen" style="
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.97); z-index: 9999; flex-direction: column;
        align-items: center; justify-content: center; backdrop-filter: blur(20px);
    ">
        <div style="
            background: linear-gradient(135deg, #1a1a1a, #111);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 20px;
            padding: 40px 30px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.8), 0 0 40px rgba(251,191,36,0.05);
            text-align: center;
        ">
            <div style="
                width: 70px; height: 70px; background: linear-gradient(135deg, #fbbf24, #d4af37);
                border-radius: 50%; display: flex; align-items: center; justify-content: center;
                margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(251,191,36,0.3);
            ">
                <i class="fas fa-shield-alt" style="font-size: 28px; color: #1a1a1a;"></i>
            </div>
            <h2 style="color: white; font-family: 'Playfair Display', serif; font-size: 24px; margin-bottom: 8px;">Backend Panel</h2>
            <p style="color: #888; font-size: 13px; margin-bottom: 30px;">Enter your admin access code to continue</p>
            
            <div style="position: relative; margin-bottom: 20px;">
                <input type="password" id="adminCodeInput" placeholder="Enter access code" 
                    style="width: 100%; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.1);
                    border-radius: 12px; padding: 15px 50px 15px 18px; color: white; font-size: 18px;
                    letter-spacing: 4px; text-align: center; outline: none; box-sizing: border-box;
                    transition: border-color 0.3s;"
                    onkeypress="if(event.key==='Enter')verifyAdminCode()"
                    oninput="this.style.borderColor='rgba(255,255,255,0.1)'; document.getElementById('adminCodeError').style.display='none'">
                <button onclick="toggleAdminCodeVis()" style="
                    position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
                    background: none; border: none; color: #888; cursor: pointer; font-size: 16px;">
                    <i class="fas fa-eye" id="adminEyeIcon"></i>
                </button>
            </div>
            
            <div id="adminCodeError" style="color: #ef4444; font-size: 13px; margin-bottom: 15px; display: none;">
                <i class="fas fa-exclamation-circle"></i> Incorrect access code
            </div>
            
            <button onclick="verifyAdminCode()" style="
                width: 100%; background: linear-gradient(135deg, #fbbf24, #d4af37);
                color: black; border: none; border-radius: 12px; padding: 15px;
                font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;
                margin-bottom: 12px;
            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <i class="fas fa-unlock-alt"></i> Access Panel
            </button>
            
            <button onclick="closeAdminPanel()" style="
                background: none; border: 1px solid rgba(255,255,255,0.1); color: #888;
                border-radius: 12px; padding: 10px 20px; cursor: pointer; font-size: 14px; transition: all 0.3s;
            ">Cancel</button>
        </div>
    </div>

    <!-- Admin Main Panel -->
    <div id="adminMainPanel" style="
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: #0a0a0a; z-index: 9998; flex-direction: column; overflow: hidden;
    ">
        <!-- Admin Header -->
        <div style="
            background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(251,191,36,0.05));
            border-bottom: 1px solid rgba(251,191,36,0.2);
            padding: 15px 20px;
            display: flex; align-items: center; gap: 15px;
            backdrop-filter: blur(10px);
        ">
            <div style="
                width: 40px; height: 40px; background: linear-gradient(135deg, #fbbf24, #d4af37);
                border-radius: 10px; display: flex; align-items: center; justify-content: center;
            ">
                <i class="fas fa-shield-alt" style="color: #1a1a1a; font-size: 18px;"></i>
            </div>
            <div style="flex:1">
                <h1 style="color: white; font-size: 18px; font-weight: bold; font-family: 'Playfair Display', serif; margin:0;">AfriConnect Admin</h1>
                <p style="color: #fbbf24; font-size: 11px; margin:0;" id="adminSubtitle">Backend Management Panel</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="adminFirebaseStatus" style="
                    padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: bold;
                    background: rgba(34,197,94,0.15); color: #22c55e; border: 1px solid rgba(34,197,94,0.2);
                ">
                    <span class="online-dot" style="width:6px;height:6px;display:inline-block;border-radius:50%;background:#22c55e;margin-right:4px;"></span>Live
                </div>
                <button onclick="closeAdminPanel()" style="
                    background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.2);
                    color: #ef4444; border-radius: 8px; padding: 8px 15px; cursor: pointer;
                    font-size: 13px; transition: all 0.3s;
                ">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        
        <!-- Admin Tabs -->
        <div style="
            display: flex; gap: 0; border-bottom: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.3); overflow-x: auto;
        " id="adminTabs">
            <button onclick="switchAdminTab('dashboard')" class="admin-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button onclick="switchAdminTab('users')" class="admin-tab" data-tab="users">
                <i class="fas fa-users"></i> Users
            </button>
            <button onclick="switchAdminTab('messages')" class="admin-tab" data-tab="messages">
                <i class="fas fa-comments"></i> Messages
            </button>
            <button onclick="switchAdminTab('firebase')" class="admin-tab" data-tab="firebase">
                <i class="fas fa-database"></i> Firebase Config
            </button>
            <button onclick="switchAdminTab('broadcast')" class="admin-tab" data-tab="broadcast">
                <i class="fas fa-bullhorn"></i> Broadcast
            </button>
        </div>
        
        <!-- Admin Content -->
        <div style="flex: 1; overflow-y: auto; padding: 20px;" id="adminContent">
            <!-- Content rendered by JS -->
        </div>
    </div>

    <style>
        .admin-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .admin-tab:hover { color: #fbbf24; background: rgba(251,191,36,0.05); }
        .admin-tab.active { color: #fbbf24; border-bottom-color: #fbbf24; background: rgba(251,191,36,0.08); }
        
        .admin-stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
        }
        .admin-stat-card:hover { border-color: rgba(251,191,36,0.3); transform: translateY(-2px); }
        
        .admin-user-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .admin-user-row:hover { background: rgba(255,255,255,0.06); border-color: rgba(251,191,36,0.2); }
        
        .admin-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        .admin-badge-green { background: rgba(34,197,94,0.15); color: #22c55e; border: 1px solid rgba(34,197,94,0.2); }
        .admin-badge-red { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.2); }
        .admin-badge-yellow { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.2); }
        
        .admin-action-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .admin-action-btn:hover { transform: scale(1.05); }
        
        .admin-input {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 10px 14px;
            color: white;
            font-size: 14px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .admin-input:focus { border-color: #fbbf24; }
        
        #adminCodeInput:focus { border-color: #fbbf24 !important; }

        .realtime-dot {
            display: inline-block;
            width: 8px; height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 6px;
        }
    </style>

    <script>
        // ==========================================
        // NETWORK STATUS CHECK
        // ==========================================
        
        function checkOnlineStatus() {
            const offlineOverlay = document.getElementById('offlineOverlay');
            if (!navigator.onLine) {
                offlineOverlay.classList.add('active');
                return false;
            } else {
                offlineOverlay.classList.remove('active');
                return true;
            }
        }

        // Check on load
        window.addEventListener('load', checkOnlineStatus);
        
        // Listen for online/offline events
        window.addEventListener('online', () => {
            document.getElementById('offlineOverlay').classList.remove('active');
            showToast("Back online! ");
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineOverlay').classList.add('active');
        });

        // ==========================================
        // AUTHENTICATION SYSTEM - FIXED FOR CROSS-DEVICE
        // ==========================================
        
        let currentUser = null;
        const AFRICA_MAP_URL = 'https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg';

        // Initialize auth on page load
        function initAuth() {
            // Check for existing session
            const session = localStorage.getItem('afriConnect_session');
            if (session) {
                try {
                    currentUser = JSON.parse(session);
                    // Verify user still exists in users database
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    if (users[currentUser.username]) {
                        // Update current user data with stored data
                        currentUser = users[currentUser.username];
                        enterApp();
                    } else {
                        // User was deleted or doesn't exist, clear session
                        localStorage.removeItem('afriConnect_session');
                        currentUser = null;
                    }
                } catch (e) {
                    localStorage.removeItem('afriConnect_session');
                    currentUser = null;
                }
            }
        }

        // Switch between login and signup tabs
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.remove('active');
                signupForm.classList.add('active');
                tabs[1].classList.add('active');
            }
            
            // Clear errors
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        // Handle Login - FIXED
        function handleLogin(e) {
            e.preventDefault();
            
            if (!checkOnlineStatus()) {
                showToast("You are offline. Please check your connection.");
                return;
            }
            
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            
            if (!users[username]) {
                errorDiv.textContent = 'Account does not exist. Please sign up first.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (users[username].password !== password) {
                errorDiv.textContent = 'Incorrect password. Please try again.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Login successful - FIXED: Store complete user data
            currentUser = users[username];
            localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
            
            showToast('Welcome back! ');
            enterApp();
        }

        // Handle Signup - FIXED
        function handleSignup(e) {
            e.preventDefault();
            
            if (!checkOnlineStatus()) {
                showToast("You are offline. Please check your connection.");
                return;
            }
            
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            const errorDiv = document.getElementById('signupError');
            const successDiv = document.getElementById('signupSuccess');
            
            // Validation
            if (username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 4) {
                errorDiv.textContent = 'Password must be at least 4 characters.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Get existing users
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            
            if (users[username]) {
                errorDiv.textContent = 'Username already exists. Please choose another.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Create new user - FIXED: Ensure all fields are properly initialized
            const newUser = {
                username: username,
                password: password,
                profile: {
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    age: 24,
                    bio: 'New to AfriConnect',
                    job: '',
                    company: '',
                    school: '',
                    phone: '',
                    gender: 'woman',
                    lookingFor: 'everyone',
                    distance: 50,
                    ageMin: 22,
                    ageMax: 30,
                    photos: [AFRICA_MAP_URL]
                },
                matches: [],
                chats: [],
                adverts: [],
                notifications: [],
                friends: [] // NEW: Friends list
            };
            
            // Save user
            users[username] = newUser;
            localStorage.setItem('afriConnect_users', JSON.stringify(users));
            
            // Auto login
            currentUser = newUser;
            localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
            
            successDiv.textContent = 'Account created successfully! Redirecting...';
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                showToast('Welcome to AfriConnect! ');
                enterApp();
            }, 1000);
        }

        // Enter the main app
        function enterApp() {
            document.getElementById('interface-container').style.display = 'none';
            document.getElementById('touchLamp').style.display = 'none';
            document.getElementById('africaMapBg').style.opacity = '0';
            document.getElementById('swipe-interface').classList.add('active');
            
            loadUserProfile();
            initDiscovery();
            initNearby();
            initGroups();
            initMatches();
            initChats();
            initMarket();
            updateNotificationBadge();
            
            // Show ENIOLA welcome after 3 seconds (delayed and subtle)
            setTimeout(() => {
                if (Math.random() > 0.5) { // Only show 50% of the time
                    showEniolaWelcome();
                }
            }, 3000);

            // Check install availability
            setTimeout(() => {
                const btn = document.getElementById('installAppBtn');
                if (btn && !_deferredPrompt) {
                    btn.disabled = true;
                    btn.querySelector('#installBtnText').textContent = 'Add to Home Screen';
                }
            }, 2000);
        }

        // Logout
        function logout() {
            currentUser = null;
            localStorage.removeItem('afriConnect_session');
            document.getElementById('swipe-interface').classList.remove('active');
            document.getElementById('interface-container').style.display = 'flex';
            document.getElementById('interface-container').style.opacity = '1';
            document.getElementById('touchLamp').style.display = 'flex';
            document.getElementById('africaMapBg').style.opacity = '0.4';
            
            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('signupForm').reset();
            switchAuthTab('login');
            
            toggleMainMenu();
        }

        // Load user profile data
        function loadUserProfile() {
            if (!currentUser) return;
            
            const profile = currentUser.profile;
            
            // Update all profile images with Africa map
            document.getElementById('userAvatar').src = profile.photos[0] || AFRICA_MAP_URL;
            document.getElementById('menuUserAvatar').src = profile.photos[0] || AFRICA_MAP_URL;
            document.getElementById('menuUserName').textContent = profile.name;
            
            // Update form fields
            document.getElementById('profileName').value = profile.name || '';
            document.getElementById('profileAge').value = profile.age || '';
            document.getElementById('profileBio').value = profile.bio || '';
            document.getElementById('profileJob').value = profile.job || '';
            document.getElementById('profileCompany').value = profile.company || '';
            document.getElementById('profileSchool').value = profile.school || '';
            document.getElementById('profilePhone').value = profile.phone || '';
            document.getElementById('distanceSlider').value = profile.distance || 50;
            document.getElementById('distanceValue').textContent = (profile.distance || 50) + ' km';
            document.getElementById('ageMin').value = profile.ageMin || 22;
            document.getElementById('ageMax').value = profile.ageMax || 30;
            document.getElementById('ageValue').textContent = (profile.ageMin || 22) + ' - ' + (profile.ageMax || 30);
            document.getElementById('lookingFor').value = profile.lookingFor || 'everyone';
            
            renderPhotoGrid();
        }

        // Save profile changes
        function saveProfile() {
            if (!currentUser) return;
            
            currentUser.profile.name = document.getElementById('profileName').value;
            currentUser.profile.age = document.getElementById('profileAge').value;
            currentUser.profile.bio = document.getElementById('profileBio').value;
            currentUser.profile.job = document.getElementById('profileJob').value;
            currentUser.profile.company = document.getElementById('profileCompany').value;
            currentUser.profile.school = document.getElementById('profileSchool').value;
            currentUser.profile.phone = document.getElementById('profilePhone').value;
            currentUser.profile.distance = document.getElementById('distanceSlider').value;
            currentUser.profile.ageMin = document.getElementById('ageMin').value;
            currentUser.profile.ageMax = document.getElementById('ageMax').value;
            currentUser.profile.lookingFor = document.getElementById('lookingFor').value;
            
            // Update storage
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            users[currentUser.username] = currentUser;
            localStorage.setItem('afriConnect_users', JSON.stringify(users));
            localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
            
            // Update UI
            document.getElementById('menuUserName').textContent = currentUser.profile.name;
            
            showToast("Profile saved! ");
        }

        // ==========================================
        // USER SEARCH FUNCTIONALITY
        // ==========================================
        
        function searchUsers(query) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!query.trim()) {
                resultsContainer.classList.remove('active');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            const allProfiles = getAllDiscoverableProfiles();
            
            // Filter users by name
            const filteredUsers = allProfiles.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) && 
                user.name !== (currentUser ? currentUser.profile.name : '')
            );
            
            if (filteredUsers.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No users found</div>';
                resultsContainer.classList.add('active');
                return;
            }
            
            resultsContainer.innerHTML = filteredUsers.map(user => {
                const isFriend = currentUser && currentUser.friends && currentUser.friends.includes(user.name);
                return `
                <div class="search-result-item" onclick="viewProfileDetails('${user.name}', 'discover')">
                    <img src="${user.img}" alt="${user.name}">
                    <div class="search-result-info">
                        <div class="search-result-name">${user.name}, ${user.age}</div>
                        <div class="search-result-meta">${user.country || 'Africa'}  ${user.distance}</div>
                    </div>
                    <button class="add-friend-btn ${isFriend ? 'added' : ''}" onclick="event.stopPropagation(); toggleFriend('${user.name}', this)">
                        ${isFriend ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-user-plus"></i> Add'}
                    </button>
                </div>
            `}).join('');
            
            resultsContainer.classList.add('active');
        }

        function toggleFriend(userName, btn) {
            if (!currentUser) return;
            
            if (!currentUser.friends) currentUser.friends = [];
            
            const index = currentUser.friends.indexOf(userName);
            if (index > -1) {
                currentUser.friends.splice(index, 1);
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Add';
                btn.classList.remove('added');
                showToast(`Removed ${userName} from friends`);
            } else {
                currentUser.friends.push(userName);
                btn.innerHTML = '<i class="fas fa-check"></i> Added';
                btn.classList.add('added');
                showToast(`Added ${userName} as friend! `);
                
                // Add notification
                addNotification({
                    id: Date.now(),
                    type: 'friend',
                    user: userName,
                    avatar: getUserAvatar(userName),
                    text: `You added <strong>${userName}</strong> as a friend!`,
                    time: 'Just now',
                    read: false
                });
            }
            
            // Save to storage
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            users[currentUser.username] = currentUser;
            localStorage.setItem('afriConnect_users', JSON.stringify(users));
            localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
        }

        function getUserAvatar(userName) {
            const allProfiles = getAllDiscoverableProfiles();
            const user = allProfiles.find(p => p.name === userName);
            return user ? user.img : AFRICA_MAP_URL;
        }

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            const resultsContainer = document.getElementById('searchResults');
            
            if (!searchContainer.contains(e.target)) {
                resultsContainer.classList.remove('active');
            }
        });

        // ==========================================
        // LAMP LOGIC
        // ==========================================
        
        const touchLamp = document.getElementById('touchLamp');
        const ropeSwitch = document.getElementById('ropeSwitch');
        const body = document.body;
        let isLightOn = false;

        function toggleLight() {
            isLightOn = !isLightOn;
            
            // Animate rope pull
            ropeSwitch.classList.add('pulled');
            setTimeout(() => {
                ropeSwitch.classList.remove('pulled');
            }, 300);
            
            if (isLightOn) {
                body.classList.add('lights-on');
            } else {
                body.classList.remove('lights-on');
            }
        }

        touchLamp.addEventListener('click', toggleLight);

        // ==========================================
        // ENIOLA BOT - MINIMAL
        // ==========================================
        
        function toggleEniola() {
            const chat = document.getElementById('eniolaChat');
            chat.classList.toggle('active');
        }

        function showEniolaWelcome() {
            const chat = document.getElementById('eniolaChat');
            chat.classList.add('active');
            
            setTimeout(() => {
                addEniolaMessage(`Hello! I'm ENIOLA, your AfriConnect assistant. Welcome! How can I help you today?`);
            }, 500);
            
            // Auto-close after 10 seconds if not interacted with
            setTimeout(() => {
                if (!document.getElementById('eniolaChat').matches(':hover')) {
                    chat.classList.remove('active');
                }
            }, 10000);
        }

        function askEniola(topic) {
            const responses = {
                'how': 'AfriConnect is simple! Browse profiles in Discover, like those you\'re interested in. If they like you back, it\'s a match! You can then chat and connect.',
                'discover': 'In Discover, you\'ll see profiles from across Africa. Tap the heart to like, X to pass, or star to super like. Filter by gender using the dropdown!',
                'market': 'The African Market Zone is where you can buy and sell items. Create your own advert by clicking the + button. No food items allowed!',
                'groups': 'Community Groups let you chat with people from specific countries and regions. Join your home state or explore other regions!',
                'safety': 'Always meet in public places, tell a friend where you\'re going, and trust your instincts. Never share financial information. Stay safe!'
            };
            
            addEniolaMessage(responses[topic] || 'I\'m here to help! Try asking about Discover, Marketplace, Groups, or Safety.');
        }

        function addEniolaMessage(text) {
            const container = document.getElementById('eniolaMessages');
            const msg = document.createElement('div');
            msg.className = 'eniola-message';
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // ==========================================
        // USER DATA STATE
        // ==========================================
        
        let userProfile = {
            name: "Amara",
            age: 24,
            bio: "Loves jazz, sunset walks, and deep conversations. Looking for someone who appreciates culture and authenticity.",
            job: "Marketing Manager",
            company: "Creative Arts Agency",
            school: "University of Lagos",
            phone: "801 234 5678",
            gender: "woman",
            lookingFor: "everyone",
            distance: 50,
            ageMin: 22,
            ageMax: 30,
            nearbyActive: true,
            photos: [
                AFRICA_MAP_URL
            ]
        };

        // Chat History Storage
        let chatHistories = {};
        let groupChatHistories = {};

        // Current Chat
        let currentChatUser = null;
        let currentGroupRoom = null;

        // User's Adverts Storage
        let myAdverts = [];

        // Notifications Data
        let notifications = [];

        // 20 Realistic Profiles from Different Countries - NO BOTS IN CHATS
        const profiles = [
            { 
                name: "Amara", 
                age: 24, 
                bio: "Loves jazz and sunset walks. Looking for deep conversations and authentic connections.", 
                distance: "5 km",
                job: "Marketing Manager",
                company: "Creative Arts Agency",
                school: "University of Lagos",
                phone: "+234 801 234 5678",
                country: "Nigeria",
                gender: "female",
                img: "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Kwame", 
                age: 28, 
                bio: "Chef & Travel enthusiast. I cook amazing jollof rice and love exploring new cultures.", 
                distance: "12 km",
                job: "Executive Chef",
                company: "Golden Spoon Restaurant",
                school: "Ghana Institute of Catering",
                phone: "+233 24 567 8901",
                country: "Ghana",
                gender: "male",
                img: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Zara", 
                age: 26, 
                bio: "Artist & Dreamer. I paint my emotions and dance when no one's watching.", 
                distance: "8 km",
                job: "Visual Artist",
                company: "Self Employed",
                school: "Makerere University",
                phone: "+256 78 901 2345",
                country: "Uganda",
                gender: "female",
                img: "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Thabo", 
                age: 30, 
                bio: "Tech entrepreneur building the future. Love hiking and wine tasting.", 
                distance: "15 km",
                job: "CEO & Founder",
                company: "AfriTech Solutions",
                school: "University of Cape Town",
                phone: "+27 83 456 7890",
                country: "South Africa",
                gender: "male",
                img: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Nia", 
                age: 23, 
                bio: "Dancer & Poet. My body speaks when words fail me.", 
                distance: "3 km",
                job: "Dance Instructor",
                company: "Lagos Dance Academy",
                school: "University of Lagos",
                phone: "+234 802 345 6789",
                country: "Nigeria",
                gender: "female",
                img: "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Kofi", 
                age: 27, 
                bio: "Music producer. I create beats that make you move. Looking for my muse.", 
                distance: "20 km",
                job: "Music Producer",
                company: "Beat Masters Studio",
                school: "National Film & Television Institute",
                phone: "+233 20 123 4567",
                country: "Ghana",
                gender: "male",
                img: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Amina", 
                age: 25, 
                bio: "Medical student passionate about healthcare. Love reading and volunteering.", 
                distance: "7 km",
                job: "Medical Student",
                company: "University of Nairobi",
                school: "University of Nairobi",
                phone: "+254 712 345 678",
                country: "Kenya",
                gender: "female",
                img: "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1489424731084-a5d8b219a5bb?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "David", 
                age: 29, 
                bio: "Photographer capturing Africa's beauty. Always looking for new adventures.", 
                distance: "11 km",
                job: "Professional Photographer",
                company: "Lens Africa",
                school: "Multimedia University",
                phone: "+254 723 456 789",
                country: "Kenya",
                gender: "male",
                img: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Fatima", 
                age: 24, 
                bio: "Fashion designer creating modern African wear. Love fashion shows and tea.", 
                distance: "9 km",
                job: "Fashion Designer",
                company: "Fatima Designs",
                school: "University of Dar es Salaam",
                phone: "+255 654 321 098",
                country: "Tanzania",
                gender: "female",
                img: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1489424731084-a5d8b219a5bb?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "James", 
                age: 31, 
                bio: "Banker by day, poet by night. Looking for someone to share sunsets with.", 
                distance: "14 km",
                job: "Investment Banker",
                company: "Standard Bank",
                school: "University of Zambia",
                phone: "+260 97 123 4567",
                country: "Zambia",
                gender: "male",
                img: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Zainab", 
                age: 27, 
                bio: "Lawyer fighting for justice. Love debates and intellectual conversations.", 
                distance: "6 km",
                job: "Corporate Lawyer",
                company: "Zainab & Associates",
                school: "University of Abuja",
                phone: "+234 803 456 7890",
                country: "Nigeria",
                gender: "female",
                img: "https://images.unsplash.com/photo-1489424731084-a5d8b219a5bb?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1489424731084-a5d8b219a5bb?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Michael", 
                age: 26, 
                bio: "Software developer building apps for Africa. Gamer and tech enthusiast.", 
                distance: "18 km",
                job: "Software Engineer",
                company: "Tech Afrika",
                school: "Addis Ababa University",
                phone: "+251 91 234 5678",
                country: "Ethiopia",
                gender: "male",
                img: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Sarah", 
                age: 22, 
                bio: "Student studying architecture. Love drawing and exploring cities.", 
                distance: "4 km",
                job: "Architecture Student",
                company: "University of Rwanda",
                school: "University of Rwanda",
                phone: "+250 78 123 4567",
                country: "Rwanda",
                gender: "female",
                img: "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Omar", 
                age: 32, 
                bio: "Businessman importing/exporting goods. Love travel and fine dining.", 
                distance: "22 km",
                job: "Import/Export Manager",
                company: "Omar Trading Co.",
                school: "University of Khartoum",
                phone: "+249 12 345 6789",
                country: "Sudan",
                gender: "male",
                img: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Grace", 
                age: 28, 
                bio: "HR professional helping companies grow. Love networking and brunches.", 
                distance: "10 km",
                job: "HR Manager",
                company: "Safaricom",
                school: "Strathmore University",
                phone: "+254 734 567 890",
                country: "Kenya",
                gender: "female",
                img: "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Ibrahim", 
                age: 25, 
                bio: "Agricultural scientist working with farmers. Love nature and farming.", 
                distance: "25 km",
                job: "Agricultural Scientist",
                company: "Ministry of Agriculture",
                school: "Kwame Nkrumah University",
                phone: "+233 54 567 8901",
                country: "Ghana",
                gender: "male",
                img: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Linda", 
                age: 29, 
                bio: "Journalist telling African stories. Love interviews and writing.", 
                distance: "13 km",
                job: "Senior Journalist",
                company: "BBC Africa",
                school: "University of Zimbabwe",
                phone: "+263 77 123 4567",
                country: "Zimbabwe",
                gender: "female",
                img: "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Samuel", 
                age: 33, 
                bio: "Civil engineer building infrastructure. Love construction and design.", 
                distance: "16 km",
                job: "Civil Engineer",
                company: "Julius Berger",
                school: "University of Ibadan",
                phone: "+234 805 678 9012",
                country: "Nigeria",
                gender: "male",
                img: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Naledi", 
                age: 26, 
                bio: "Environmental activist protecting our planet. Love hiking and camping.", 
                distance: "19 km",
                job: "Environmental Consultant",
                company: "Green Africa",
                school: "University of Botswana",
                phone: "+267 71 234 567",
                country: "Botswana",
                gender: "female",
                img: "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            },
            { 
                name: "Jean", 
                age: 30, 
                bio: "Hotel manager providing luxury experiences. Love hospitality and travel.", 
                distance: "21 km",
                job: "Hotel Manager",
                company: "Serena Hotel",
                school: "University of Burundi",
                phone: "+257 79 123 456",
                country: "Burundi",
                gender: "male",
                img: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop", 
                photos: [
                    "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400&h=600&fit=crop",
                    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop"
                ],
                verified: false,
                isBot: false
            }
        ];

        // Nearby People Data - NO BOTS
        let nearbyPeople = [
            { name: "Amina", age: 25, distance: "0.5 km", img: "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=400&h=400&fit=crop", online: true, isBot: false },
            { name: "David", age: 29, distance: "1.2 km", img: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop", online: true, isBot: false },
            { name: "Fatima", age: 24, distance: "2.1 km", img: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=400&fit=crop", online: false, isBot: false },
            { name: "James", age: 31, distance: "3.5 km", img: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop", online: true, isBot: false },
            { name: "Zainab", age: 27, distance: "4.2 km", img: "https://images.unsplash.com/photo-1489424731084-a5d8b219a5bb?w=400&h=400&fit=crop", online: false, isBot: false },
            { name: "Michael", age: 26, distance: "4.8 km", img: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop", online: true, isBot: false },
        ];

        // Initialize matches and chats from currentUser if available
        let matches = [];
        let chats = [];

        // African Countries Data with States/Regions
        const africanCountries = [
            {
                name: "Nigeria",
                flag: "",
                code: "+234",
                rooms: [
                    "Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue", "Borno",
                    "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu", "Gombe", "Imo",
                    "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi", "Kwara", "Lagos",
                    "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo", "Plateau", "Rivers",
                    "Sokoto", "Taraba", "Yobe", "Zamfara", "FCT Abuja"
                ]
            },
            {
                name: "Ghana",
                flag: "",
                code: "+233",
                rooms: [
                    "Ahafo", "Ashanti", "Bono", "Bono East", "Central", "Eastern", "Greater Accra",
                    "North East", "Northern", "Oti", "Savannah", "Upper East", "Upper West", "Volta", "Western", "Western North"
                ]
            },
            {
                name: "Kenya",
                flag: "",
                code: "+254",
                rooms: [
                    "Baringo", "Bomet", "Bungoma", "Busia", "Elgeyo-Marakwet", "Embu", "Garissa",
                    "Homa Bay", "Isiolo", "Kajiado", "Kakamega", "Kericho", "Kiambu", "Kilifi",
                    "Kirinyaga", "Kisii", "Kisumu", "Kitui", "Kwale", "Laikipia", "Lamu", "Machakos",
                    "Makueni", "Mandera", "Marsabit", "Meru", "Migori", "Mombasa", "Murang'a",
                    "Nairobi City", "Nakuru", "Nandi", "Narok", "Nyamira", "Nyandarua", "Nyeri",
                    "Samburu", "Siaya", "Taita-Taveta", "Tana River", "Tharaka-Nithi", "Trans Nzoia",
                    "Turkana", "Uasin Gishu", "Vihiga", "Wajir", "West Pokot"
                ]
            },
            {
                name: "South Africa",
                flag: "",
                code: "+27",
                rooms: [
                    "Eastern Cape", "Free State", "Gauteng", "KwaZulu-Natal", "Limpopo", "Mpumalanga",
                    "North West", "Northern Cape", "Western Cape"
                ]
            },
            {
                name: "Uganda",
                flag: "",
                code: "+256",
                rooms: [
                    "Abim", "Adjumani", "Agago", "Alebtong", "Amolatar", "Amudat", "Amuria", "Amuru",
                    "Apac", "Arua", "Budaka", "Bududa", "Bugiri", "Buhweju", "Buikwe", "Bukedea",
                    "Bukomansimbi", "Bukwo", "Bulambuli", "Buliisa", "Bundibugyo", "Bunyangabu",
                    "Bushenyi", "Busia", "Butaleja", "Butambala", "Butebo", "Buvuma", "Buyende",
                    "Dokolo", "Gomba", "Gulu", "Hoima", "Ibanda", "Iganga", "Isingiro", "Jinja",
                    "Kaabong", "Kabale", "Kabarole", "Kaberamaido", "Kagadi", "Kakumiro", "Kalangala",
                    "Kaliro", "Kalungu", "Kampala", "Kamuli", "Kamwenge", "Kanungu", "Kapchorwa",
                    "Kapelebyong", "Karenga", "Kasanda", "Kasese", "Katakwi", "Kayunga", "Kazo",
                    "Kibaale", "Kiboga", "Kibuku", "Kigulu", "Kiruhura", "Kiryandongo", "Kisoro",
                    "Kitagwenda", "Kitgum", "Koboko", "Kole", "Kotido", "Kumi", "Kwania", "Kween",
                    "Kyankwanzi", "Kyegegwa", "Kyenjojo", "Kyotera", "Lamwo", "Lira", "Luuka", "Luwero",
                    "Lwengo", "Lyantonde", "Manafwa", "Maracha", "Masaka", "Masindi", "Mayuge", "Mbale",
                    "Mbarara", "Mitooma", "Mityana", "Moroto", "Moyo", "Mpigi", "Mubende", "Mukono",
                    "Nabilatuk", "Nakapiripirit", "Nakaseke", "Nakasongola", "Namayingo", "Namisindwa",
                    "Namutumba", "Napak", "Nebbi", "Ngora", "Ntoroko", "Ntungamo", "Nwoya", "Omoro",
                    "Otuke", "Oyam", "Pader", "Pakwach", "Pallisa", "Rakai", "Rubanda", "Rubirizi",
                    "Rukiga", "Rukungiri", "Rwampara", "Serere", "Sheema", "Sironko", "Soroti", "Tororo",
                    "Wakiso", "Yumbe", "Zombo"
                ]
            },
            {
                name: "Tanzania",
                flag: "",
                code: "+255",
                rooms: [
                    "Arusha", "Dar es Salaam", "Dodoma", "Geita", "Iringa", "Kagera", "Katavi",
                    "Kigoma", "Kilimanjaro", "Lindi", "Manyara", "Mara", "Mbeya", "Mjini Magharibi",
                    "Morogoro", "Mtwara", "Mwanza", "Njombe", "Pemba North", "Pemba South", "Pwani",
                    "Rukwa", "Ruvuma", "Shinyanga", "Simiyu", "Singida", "Songwe", "Tabora", "Tanga"
                ]
            },
            {
                name: "Ethiopia",
                flag: "",
                code: "+251",
                rooms: [
                    "Addis Ababa", "Afar", "Amhara", "Benishangul-Gumuz", "Central", "Dire Dawa",
                    "Gambela", "Harari", "Oromia", "Sidama", "Somali", "South West", "SNNPR", "Tigray"
                ]
            },
            {
                name: "Cameroon",
                flag: "",
                code: "+237",
                rooms: [
                    "Adamawa", "Centre", "East", "Far North", "Littoral", "North", "Northwest",
                    "South", "Southwest", "West"
                ]
            },
            {
                name: "Ivory Coast",
                flag: "",
                code: "+225",
                rooms: [
                    "Abidjan", "Bas-Sassandra", "Como", "Dengul", "Gh-Djiboua", "Lacs", "Lagunes",
                    "Montagnes", "Sassandra-Marahou", "Savanes", "Valle du Bandama", "Woroba", "Yamoussoukro", "Zanzan"
                ]
            },
            {
                name: "Senegal",
                flag: "",
                code: "+221",
                rooms: [
                    "Dakar", "Diourbel", "Fatick", "Kaffrine", "Kaolack", "Kdougou", "Kolda",
                    "Louga", "Matam", "Saint-Louis", "Sdhiou", "Tambacounda", "This", "Ziguinchor"
                ]
            },
            {
                name: "Zimbabwe",
                flag: "",
                code: "+263",
                rooms: [
                    "Bulawayo", "Harare", "Manicaland", "Mashonaland Central", "Mashonaland East",
                    "Mashonaland West", "Masvingo", "Matabeleland North", "Matabeleland South", "Midlands"
                ]
            },
            {
                name: "Rwanda",
                flag: "",
                code: "+250",
                rooms: [
                    "Kigali", "Eastern", "Northern", "Southern", "Western"
                ]
            },
            {
                name: "Botswana",
                flag: "",
                code: "+267",
                rooms: [
                    "Central", "Ghanzi", "Kgalagadi", "Kgatleng", "Kweneng", "North East", "North West",
                    "South East", "Southern"
                ]
            },
            {
                name: "Zambia",
                flag: "",
                code: "+260",
                rooms: [
                    "Central", "Copperbelt", "Eastern", "Luapula", "Lusaka", "Muchinga", "Northern",
                    "North Western", "Southern", "Western"
                ]
            },
            {
                name: "Mali",
                flag: "",
                code: "+223",
                rooms: [
                    "Bamako", "Gao", "Kayes", "Kidal", "Koulikoro", "Mnaka", "Mopti", "Sgou", "Sikasso", "Taoudnit", "Tombouctou"
                ]
            },
            {
                name: "Burkina Faso",
                flag: "",
                code: "+226",
                rooms: [
                    "Bal", "Bam", "Banwa", "Bazga", "Bougouriba", "Boulgou", "Boulkiemd", "Como",
                    "Ganzourgou", "Gnagna", "Gourma", "Houet", "Ioba", "Kadiogo", "Kndougou", "Komondjari",
                    "Kompienga", "Kossi", "Koulplogo", "Kouritenga", "Kourwogo", "Lraba", "Loroum",
                    "Mouhoun", "Nahouri", "Namentenga", "Nayala", "Noumbiel", "Oubritenga", "Oudalan",
                    "Passor", "Poni", "Sangui", "Sanmatenga", "Sno", "Sissili", "Soum", "Sourou",
                    "Tapoa", "Tuy", "Yagha", "Yatenga", "Ziro", "Zondoma", "Zoundwogo"
                ]
            },
            {
                name: "Madagascar",
                flag: "",
                code: "+261",
                rooms: [
                    "Antananarivo", "Antsiranana", "Fianarantsoa", "Mahajanga", "Toamasina", "Toliara"
                ]
            },
            {
                name: "Malawi",
                flag: "",
                code: "+265",
                rooms: [
                    "Central Region", "Northern Region", "Southern Region"
                ]
            },
            {
                name: "Niger",
                flag: "",
                code: "+227",
                rooms: [
                    "Agadez", "Diffa", "Dosso", "Maradi", "Niamey", "Tahoua", "Tillabri", "Zinder"
                ]
            }
        ];

        // Initialize chat histories
        function initializeChatHistories() {
            chatHistories = {};
            chats.forEach(chat => {
                chatHistories[chat.name] = [
                    { text: chat.message, sent: false, time: chat.time }
                ];
            });
        }

        // ==========================================
        // MAIN MENU FUNCTIONS
        // ==========================================
        
        function toggleMainMenu() {
            const overlay = document.getElementById('mainMenuOverlay');
            const panel = document.getElementById('mainMenuPanel');
            
            overlay.classList.toggle('active');
            panel.classList.toggle('active');
        }

        function showSectionFromMenu(section) {
            toggleMainMenu();
            showSection(section);
            // Update bottom nav active state
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (section === 'swipe') document.querySelectorAll('.nav-item')[0].classList.add('active');
            else if (section === 'nearby') document.querySelectorAll('.nav-item')[1].classList.add('active');
            else if (section === 'matches') document.querySelectorAll('.nav-item')[2].classList.add('active');
            else if (section === 'messages') document.querySelectorAll('.nav-item')[3].classList.add('active');
        }

        // Section Navigation
        function showSection(section) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`section-${section}`).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        // ==========================================
        // DISCOVERY FUNCTIONS - NOW INCLUDES ALL USERS
        // ==========================================
        
        function getAllDiscoverableProfiles() {
            // Get all registered users from localStorage
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            const allProfiles = [...profiles]; // Start with hardcoded profiles
            
            // Add registered users who aren't the current user
            Object.values(users).forEach(user => {
                if (currentUser && user.username === currentUser.username) return; // Skip current user
                
                // Check if this user is already in profiles (by username)
                const exists = allProfiles.some(p => p.name === user.username);
                if (!exists) {
                    // Convert user object to profile format
                    const userProfile = {
                        name: user.profile.name || user.username,
                        age: user.profile.age || 24,
                        bio: user.profile.bio || 'New to AfriConnect',
                        distance: `${Math.floor(Math.random() * 20) + 1} km`,
                        job: user.profile.job || 'Member',
                        company: user.profile.company || 'AfriConnect',
                        school: user.profile.school || '',
                        phone: user.profile.phone || '',
                        country: 'Africa',
                        gender: user.profile.gender === 'man' ? 'male' : (user.profile.gender === 'woman' ? 'female' : 'other'),
                        img: user.profile.photos && user.profile.photos.length > 0 ? user.profile.photos[0] : AFRICA_MAP_URL,
                        photos: user.profile.photos && user.profile.photos.length > 0 ? user.profile.photos : [AFRICA_MAP_URL],
                        verified: false,
                        isRegisteredUser: true,
                        username: user.username,
                        isBot: false
                    };
                    allProfiles.push(userProfile);
                }
            });
            
            return allProfiles;
        }

        function initDiscovery() {
            const allProfiles = getAllDiscoverableProfiles();
            renderDiscoveryGrid(allProfiles);
        }

        function renderDiscoveryGrid(profileList) {
            const grid = document.getElementById('discoveryGrid');
            grid.innerHTML = profileList.map(profile => {
                const verifiedBadge = profile.verified ? 
                    `<span class="verification-badge"><i class="fas fa-check-circle"></i></span>` : '';
                
                return `
                <div class="grid-profile-card" onclick="viewProfileDetails('${profile.name}', 'discover')">
                    <img src="${profile.img}" class="grid-profile-image" alt="${profile.name}">
                    <div class="grid-profile-info">
                        <div class="flex items-center mb-1">
                            <h3 class="text-sm font-bold text-white">${profile.name}, ${profile.age}</h3>
                            ${verifiedBadge}
                        </div>
                        <p class="text-yellow-500 text-xs mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${profile.distance}</p>
                        <p class="text-gray-400 text-xs">${profile.country}</p>
                    </div>
                    <div class="grid-profile-actions">
                        <button class="grid-action-btn pass" onclick="event.stopPropagation(); passProfile('${profile.name}')">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="grid-action-btn like" onclick="event.stopPropagation(); likeProfile('${profile.name}')">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="grid-action-btn super" onclick="event.stopPropagation(); superLikeProfile('${profile.name}')">
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function filterDiscovery(filter) {
            const allProfiles = getAllDiscoverableProfiles();
            let filtered = allProfiles;
            
            if (filter === 'male') {
                filtered = allProfiles.filter(p => p.gender === 'male');
            } else if (filter === 'female') {
                filtered = allProfiles.filter(p => p.gender === 'female');
            } else if (filter === 'verified') {
                filtered = allProfiles.filter(p => p.verified);
            }
            
            renderDiscoveryGrid(filtered);
        }

        function passProfile(name) {
            showToast(`Passed on ${name}`);
            const card = event.target.closest('.grid-profile-card');
            card.style.opacity = '0.5';
        }

        function likeProfile(name) {
            showToast(`Liked ${name}! `);
            const card = event.target.closest('.grid-profile-card');
            card.style.border = '2px solid #22c55e';
            
            // Add to matches if it's a registered user (simulated mutual like)
            const allProfiles = getAllDiscoverableProfiles();
            const likedProfile = allProfiles.find(p => p.name === name);
            
            if (likedProfile && likedProfile.isRegisteredUser) {
                // Simulate a match after a delay
                setTimeout(() => {
                    addMatch(likedProfile);
                }, 2000);
            }
            
            setTimeout(() => {
                card.style.display = 'none';
            }, 500);
        }

        function superLikeProfile(name) {
            showToast(`Super Liked ${name}! `);
            const card = event.target.closest('.grid-profile-card');
            card.style.border = '2px solid #3b82f6';
            
            // Add to matches immediately for super like
            const allProfiles = getAllDiscoverableProfiles();
            const likedProfile = allProfiles.find(p => p.name === name);
            
            if (likedProfile) {
                addMatch(likedProfile);
            }
            
            setTimeout(() => {
                card.style.display = 'none';
            }, 500);
        }

        function addMatch(profile) {
            // Check if already in matches
            const exists = matches.some(m => m.name === profile.name);
            if (exists) return;
            
            const newMatch = {
                name: profile.name,
                age: profile.age,
                img: profile.img,
                lastActive: "Active now",
                bio: profile.bio,
                job: profile.job,
                company: profile.company,
                school: profile.school,
                phone: profile.phone,
                photos: profile.photos,
                isBot: profile.isBot || false
            };
            
            matches.unshift(newMatch);
            
            // Add to chats as well so they can be messaged
            const newChat = {
                name: profile.name,
                message: "You matched! Say hello ",
                time: "Just now",
                unread: 1,
                img: profile.img,
                bio: profile.bio,
                job: profile.job,
                company: profile.company,
                school: profile.school,
                phone: profile.phone,
                age: profile.age,
                photos: profile.photos,
                isBot: profile.isBot || false
            };
            
            // Check if chat already exists
            const existingChat = chats.find(c => c.name === profile.name);
            if (!existingChat) {
                chats.unshift(newChat);
                chatHistories[profile.name] = [
                    { text: "You matched! Say hello ", sent: false, time: "Just now" }
                ];
            }
            
            // Save to currentUser
            if (currentUser) {
                currentUser.matches = matches;
                currentUser.chats = chats;
                const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                users[currentUser.username] = currentUser;
                localStorage.setItem('afriConnect_users', JSON.stringify(users));
                localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
            }
            
            initMatches();
            initChats();
            
            // Add notification
            addNotification({
                id: Date.now(),
                type: 'match',
                user: profile.name,
                avatar: profile.img,
                text: `You matched with <strong>${profile.name}</strong>! Start chatting now.`,
                time: 'Just now',
                read: false
            });
            
            showToast(`It's a Match with ${profile.name}! `);
        }

        // ==========================================
        // NOTIFICATION FUNCTIONS
        // ==========================================
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                renderNotifications();
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notificationList');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            document.getElementById('notifCount').textContent = unreadCount > 0 ? `${unreadCount} new` : '0 new';
            const badge = document.getElementById('notifBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            if (notifications.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">No notifications yet</div>';
                return;
            }
            
            list.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="handleNotificationClick(${notif.id})">
                    <img src="${notif.avatar}" class="notification-avatar" alt="${notif.user}">
                    <div class="notification-content">
                        <div class="notification-text">${notif.text}</div>
                        <div class="notification-time">${notif.time}</div>
                    </div>
                    <i class="fas fa-times notification-delete" onclick="event.stopPropagation(); deleteNotification(${notif.id})"></i>
                </div>
            `).join('');
        }

        function addNotification(notification) {
            notifications.unshift(notification);
            updateNotificationBadge();
        }

        function handleNotificationClick(id) {
            const notif = notifications.find(n => n.id === id);
            if (!notif) return;
            
            notif.read = true;
            updateNotificationBadge();
            renderNotifications();
            
            if (notif.type === 'match' || notif.type === 'message' || notif.type === 'friend') {
                const userName = notif.user;
                
                // Find in matches first
                const match = matches.find(m => m.name === userName);
                if (match) {
                    toggleNotifications();
                    openChat(userName);
                    return;
                }
                
                // Then check chats
                const chat = chats.find(c => c.name === userName);
                if (chat) {
                    toggleNotifications();
                    openChat(userName);
                    return;
                }
                
                // If not found, try to find profile and create chat
                const allProfiles = getAllDiscoverableProfiles();
                const profile = allProfiles.find(p => p.name === userName);
                if (profile) {
                    // Create a match and chat for this user
                    addMatch(profile);
                    toggleNotifications();
                    setTimeout(() => openChat(userName), 500);
                }
            } else {
                toggleNotifications();
                showSection('swipe');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            }
        }

        function deleteNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
            updateNotificationBadge();
        }

        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notifBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==========================================
        // NEARBY FUNCTIONS - NOW INCLUDES ALL USERS
        // ==========================================
        
        function getAllNearbyPeople() {
            // Get all registered users from localStorage
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            const allNearby = [...nearbyPeople]; // Start with hardcoded nearby people
            
            // Add registered users who aren't the current user
            Object.values(users).forEach(user => {
                if (currentUser && user.username === currentUser.username) return; // Skip current user
                
                // Check if this user is already in nearbyPeople
                const exists = allNearby.some(p => p.name === (user.profile.name || user.username));
                if (!exists) {
                    const distance = (Math.random() * 5).toFixed(1);
                    const nearbyUser = {
                        name: user.profile.name || user.username,
                        age: user.profile.age || 24,
                        distance: `${distance} km`,
                        img: user.profile.photos && user.profile.photos.length > 0 ? user.profile.photos[0] : AFRICA_MAP_URL,
                        online: Math.random() > 0.3, // 70% chance online
                        isRegisteredUser: true,
                        username: user.username,
                        isBot: false
                    };
                    allNearby.push(nearbyUser);
                }
            });
            
            return allNearby;
        }

        function initNearby() {
            const allNearby = getAllNearbyPeople();
            renderNearbyGrid(allNearby);
        }

        function renderNearbyGrid(peopleList) {
            const grid = document.getElementById('nearbyGrid');
            document.getElementById('nearbyCountText').textContent = `${peopleList.length} people within 5 km`;
            
            grid.innerHTML = peopleList.map(person => `
                <div class="nearby-card" onclick="viewNearbyProfile('${person.name}')">
                    <img src="${person.img}" alt="${person.name}">
                    <div class="nearby-distance">${person.distance}</div>
                    ${person.online ? '<div class="nearby-online"></div>' : ''}
                </div>
            `).join('');
        }

        function toggleNearby(element) {
            element.classList.toggle('active');
            userProfile.nearbyActive = element.classList.contains('active');
            showToast(userProfile.nearbyActive ? "Nearby mode activated! " : "Nearby mode disabled");
        }

        function filterNearby(distance) {
            showToast(`Showing people within ${distance} km`);
            // In a real app, this would filter by actual distance
        }

        function viewNearbyProfile(name) {
            const allNearby = getAllNearbyPeople();
            const person = allNearby.find(p => p.name === name);
            if (!person) return;
            
            // Get full profile if it's a registered user
            const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
            const userData = Object.values(users).find(u => (u.profile.name || u.username) === name);
            
            const profile = userData ? {
                ...person,
                bio: userData.profile.bio || 'New to AfriConnect',
                job: userData.profile.job || 'Member',
                company: userData.profile.company || 'AfriConnect',
                school: userData.profile.school || '',
                phone: userData.profile.phone || 'Hidden',
                photos: userData.profile.photos || [person.img],
                isBot: false
            } : {
                ...person,
                bio: "Nearby user looking to connect!",
                job: "Unknown",
                company: "Unknown",
                school: "Unknown",
                phone: "Hidden",
                photos: [person.img],
                isBot: false
            };
            
            currentViewingProfile = profile;
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileModalContent');
            const actions = document.getElementById('profileModalActions');
            
            content.innerHTML = `
                <div class="profile-hero">
                    <img src="${profile.img}" alt="${profile.name}">
                    <div class="profile-hero-info">
                        <h2 class="text-3xl font-bold text-white mb-2">${profile.name}, ${profile.age}</h2>
                        <p class="text-yellow-400 text-sm"><i class="fas fa-map-marker-alt mr-2"></i>${profile.distance} away</p>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">About</h3>
                    <p class="text-gray-300 text-sm leading-relaxed">${profile.bio}</p>
                </div>
            `;
            
            actions.innerHTML = `
                <button class="action-bar-btn dislike" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
                <button class="action-bar-btn like" onclick="closeProfileModal(); showToast('Like sent! ')">
                    <i class="fas fa-heart"></i>
                </button>
            `;
            
            modal.classList.add('active');
        }

        // ==========================================
        // GROUP CHAT FUNCTIONS
        // ==========================================
        
        function initGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = africanCountries.map(country => `
                <div class="country-group">
                    <div class="country-header" onclick="toggleCountry('${country.name}')">
                        <div class="country-name">
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        </div>
                        <span class="room-count">${country.rooms.length} rooms</span>
                    </div>
                    <div class="rooms-container" id="rooms-${country.name}">
                        <div class="rooms-grid">
                            ${country.rooms.map(room => `
                                <div class="room-card" onclick="openGroupChat('${country.name}', '${room}')">
                                    <div class="room-name">${room}</div>
                                    <div class="room-users">
                                        <span class="online-dot"></span>
                                        ${Math.floor(Math.random() * 50) + 5} online
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCountry(countryName) {
            const container = document.getElementById(`rooms-${countryName}`);
            container.classList.toggle('expanded');
        }

        function openGroupChat(country, room) {
            currentGroupRoom = { country, room };
            const chatBox = document.getElementById('groupChatBox');
            
            document.getElementById('groupChatName').textContent = `${room}, ${country}`;
            document.getElementById('groupChatMeta').textContent = `${Math.floor(Math.random() * 100) + 20} members  Community Chat Room`;
            
            const membersContainer = document.getElementById('groupMembersPreview');
            const avatars = [
                'https://images.unsplash.com/photo-1531123897727-8f129e1688ce?w=100&h=100&fit=crop',
                'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=100&h=100&fit=crop',
                'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=100&h=100&fit=crop',
                'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop'
            ];
            
            membersContainer.innerHTML = avatars.map(src => `
                <img src="${src}" class="member-avatar" alt="Member">
            `).join('') + `<div class="member-count">+${Math.floor(Math.random() * 50) + 10}</div>`;
            
            chatBox.classList.add('active');
            renderGroupMessages(country, room);
        }

        function closeGroupChat() {
            document.getElementById('groupChatBox').classList.remove('active');
            currentGroupRoom = null;
        }

        function renderGroupMessages(country, room) {
            const container = document.getElementById('groupChatMessages');
            const key = `${country}-${room}`;
            
            if (!groupChatHistories[key]) {
                groupChatHistories[key] = [
                    { text: `Welcome to ${room} chat room! Connect with people from this region.`, sent: false, time: 'Now', user: 'Admin' }
                ];
            }
            
            const messages = groupChatHistories[key];
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.sent ? 'sent' : 'received'}">
                    ${!msg.sent ? `<div style="font-size: 10px; color: #fbbf24; margin-bottom: 2px;">${msg.user}</div>` : ''}
                    <div>${msg.text}</div>
                    <div class="message-time">${msg.time}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendGroupMessage() {
            const input = document.getElementById('groupChatInput');
            const text = input.value.trim();
            
            if (!text || !currentGroupRoom) return;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const key = `${currentGroupRoom.country}-${currentGroupRoom.room}`;
            
            if (!groupChatHistories[key]) {
                groupChatHistories[key] = [];
            }
            
            groupChatHistories[key].push({
                text: text,
                sent: true,
                time: time,
                user: 'You'
            });
            
            input.value = '';
            renderGroupMessages(currentGroupRoom.country, currentGroupRoom.room);
        }

        function handleGroupChatKeypress(e) {
            if (e.key === 'Enter') {
                sendGroupMessage();
            }
        }

        // ==========================================
        // MARKET FUNCTIONS
        // ==========================================
        
        let marketItems = [];
        let currentViewingItem = null;

        function initMarket() {
            if (currentUser && currentUser.adverts) {
                myAdverts = currentUser.adverts;
            }
            renderMarketItems();
        }

        function renderMarketItems() {
            const grid = document.getElementById('marketGrid');
            const allItems = [...marketItems, ...myAdverts];
            
            if (allItems.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #888; padding: 40px; grid-column: 1/-1;">No items available. Be the first to sell something!</div>';
                return;
            }
            
            grid.innerHTML = allItems.map(item => `
                <div class="market-item" onclick="viewMarketItem(${item.id})">
                    <img src="${item.image}" class="market-item-image" alt="${item.title}">
                    <div class="market-item-info">
                        <div class="market-item-price">${item.price}</div>
                        <div class="market-item-title">${item.title}</div>
                        <div class="market-item-location">
                            <i class="fas fa-map-marker-alt"></i> ${item.location}
                        </div>
                        <div class="market-item-seller">
                            <img src="${item.seller.avatar}" class="seller-avatar" alt="${item.seller.name}">
                            <span class="seller-name">${item.seller.name}</span>
                            <span style="color: #fbbf24; margin-left: auto;"><i class="fas fa-star"></i> ${item.seller.rating}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterMarket(category, element) {
            document.querySelectorAll('.market-category').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            
            const allItems = [...marketItems, ...myAdverts];
            
            if (category === 'all') {
                renderMarketItems();
            } else {
                const filtered = allItems.filter(item => item.category === category);
                const grid = document.getElementById('marketGrid');
                
                if (filtered.length === 0) {
                    grid.innerHTML = '<div style="text-align: center; color: #888; padding: 40px; grid-column: 1/-1;">No items in this category</div>';
                    return;
                }
                
                grid.innerHTML = filtered.map(item => `
                    <div class="market-item" onclick="viewMarketItem(${item.id})">
                        <img src="${item.image}" class="market-item-image" alt="${item.title}">
                        <div class="market-item-info">
                            <div class="market-item-price">${item.price}</div>
                            <div class="market-item-title">${item.title}</div>
                            <div class="market-item-location">
                                <i class="fas fa-map-marker-alt"></i> ${item.location}
                            </div>
                            <div class="market-item-seller">
                                <img src="${item.seller.avatar}" class="seller-avatar" alt="${item.seller.name}">
                                <span class="seller-name">${item.seller.name}</span>
                                <span style="color: #fbbf24; margin-left: auto;"><i class="fas fa-star"></i> ${item.seller.rating}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function searchMarket(query) {
            const allItems = [...marketItems, ...myAdverts];
            const filtered = allItems.filter(item => 
                item.title.toLowerCase().includes(query.toLowerCase()) ||
                item.location.toLowerCase().includes(query.toLowerCase())
            );
            
            const grid = document.getElementById('marketGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #888; padding: 40px; grid-column: 1/-1;">No items found</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(item => `
                <div class="market-item" onclick="viewMarketItem(${item.id})">
                    <img src="${item.image}" class="market-item-image" alt="${item.title}">
                    <div class="market-item-info">
                        <div class="market-item-price">${item.price}</div>
                        <div class="market-item-title">${item.title}</div>
                        <div class="market-item-location">
                            <i class="fas fa-map-marker-alt"></i> ${item.location}
                        </div>
                        <div class="market-item-seller">
                            <img src="${item.seller.avatar}" class="seller-avatar" alt="${item.seller.name}">
                            <span class="seller-name">${item.seller.name}</span>
                            <span style="color: #fbbf24; margin-left: auto;"><i class="fas fa-star"></i> ${item.seller.rating}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewMarketItem(id) {
            const allItems = [...marketItems, ...myAdverts];
            const item = allItems.find(i => i.id === id);
            if (!item) return;
            
            currentViewingItem = item;
            
            const modal = document.getElementById('marketDetailModal');
            const content = document.getElementById('marketDetailContent');
            
            content.innerHTML = `
                <img src="${item.image}" class="market-detail-image" alt="${item.title}">
                <div class="market-detail-info">
                    <div class="market-detail-price">${item.price}</div>
                    <div class="market-detail-title">${item.title}</div>
                    
                    <div class="market-detail-meta">
                        <div class="market-meta-row">
                            <span style="color: #888; font-size: 13px;">Condition</span>
                            <span style="color: white; font-weight: bold; font-size: 13px;">${item.condition}</span>
                        </div>
                        <div class="market-meta-row">
                            <span style="color: #888; font-size: 13px;">Posted</span>
                            <span style="color: white; font-size: 13px;">${item.posted}</span>
                        </div>
                        <div class="market-meta-row">
                            <span style="color: #888; font-size: 13px;">Location</span>
                            <span style="color: white; font-size: 13px;"><i class="fas fa-map-marker-alt" style="color: #fbbf24;"></i> ${item.location}</span>
                        </div>
                    </div>
                    
                    <div class="market-detail-description">
                        <h4 style="color: #fbbf24; margin-bottom: 8px; font-size: 14px;">Description</h4>
                        <p style="font-size: 13px;">${item.description}</p>
                    </div>
                    
                    <div class="market-seller-card">
                        <img src="${item.seller.avatar}" class="market-seller-avatar" alt="${item.seller.name}">
                        <div class="market-seller-info">
                            <div class="market-seller-name">${item.seller.name}</div>
                            <div class="market-seller-rating"><i class="fas fa-star"></i> ${item.seller.rating} rating</div>
                        </div>
                    </div>
                    
                    <button class="market-contact-btn" onclick="contactSeller()">
                        <i class="fas fa-comment-dots"></i> Contact Seller
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMarketDetail() {
            document.getElementById('marketDetailModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function contactSeller() {
            showToast(`Message sent to ${currentViewingItem.seller.name}! `);
            closeMarketDetail();
        }

        // ==========================================
        // CREATE ADVERT FUNCTIONS
        // ==========================================
        
        let advertImages = [];

        function openCreateAdvert() {
            document.getElementById('createAdvertModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            advertImages = [];
            document.getElementById('advertForm').reset();
            document.getElementById('advertImagePreview').innerHTML = '';
        }

        function closeCreateAdvert() {
            document.getElementById('createAdvertModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function previewAdvertImages(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('advertImagePreview');
            
            for (let i = 0; i < files.length && i < 5; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    advertImages.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '60px';
                    img.style.height = '60px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(files[i]);
            }
        }

        function submitAdvert(event) {
            event.preventDefault();
            
            const title = document.getElementById('advertTitle').value;
            const category = document.getElementById('advertCategory').value;
            const price = document.getElementById('advertPrice').value;
            const location = document.getElementById('advertLocation').value;
            const condition = document.getElementById('advertCondition').value;
            const description = document.getElementById('advertDescription').value;
            
            const newAdvert = {
                id: Date.now(),
                title: title,
                price: price,
                category: category,
                location: location,
                image: advertImages.length > 0 ? advertImages[0] : AFRICA_MAP_URL,
                seller: {
                    name: currentUser ? currentUser.profile.name : 'User',
                    avatar: currentUser ? (currentUser.profile.photos[0] || AFRICA_MAP_URL) : AFRICA_MAP_URL,
                    rating: "5.0"
                },
                description: description,
                condition: condition,
                posted: "Just now"
            };
            
            myAdverts.unshift(newAdvert);
            
            // Save to user account
            if (currentUser) {
                currentUser.adverts = myAdverts;
                const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                users[currentUser.username] = currentUser;
                localStorage.setItem('afriConnect_users', JSON.stringify(users));
                localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
            }
            
            showToast('Advert posted successfully! ');
            closeCreateAdvert();
            initMarket();
        }

        function showMyAdverts() {
            toggleMainMenu();
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-myadverts').classList.add('active');
            renderMyAdverts();
        }

        function renderMyAdverts() {
            const container = document.getElementById('myAdvertsContainer');
            
            if (myAdverts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">You haven\'t created any adverts yet.</p>';
                return;
            }
            
            container.innerHTML = myAdverts.map(advert => `
                <div class="my-advert-card">
                    <img src="${advert.image}" class="my-advert-image" alt="${advert.title}">
                    <div class="my-advert-info">
                        <span class="my-advert-status status-active">Active</span>
                        <h3 style="color: white; margin-bottom: 5px; font-size: 16px;">${advert.title}</h3>
                        <p style="color: #fbbf24; font-size: 16px; font-weight: bold; margin-bottom: 5px;">${advert.price}</p>
                        <p style="color: #888; font-size: 12px;"><i class="fas fa-map-marker-alt"></i> ${advert.location}</p>
                        <button class="delete-advert-btn" onclick="deleteAdvert(${advert.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteAdvert(id) {
            if (confirm('Are you sure you want to delete this advert?')) {
                myAdverts = myAdverts.filter(a => a.id !== id);
                
                // Update user account
                if (currentUser) {
                    currentUser.adverts = myAdverts;
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    users[currentUser.username] = currentUser;
                    localStorage.setItem('afriConnect_users', JSON.stringify(users));
                    localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                }
                
                renderMyAdverts();
                initMarket();
                showToast('Advert deleted');
            }
        }

        // ==========================================
        // PROFILE DETAIL FUNCTIONS
        // ==========================================
        
        let currentViewingProfile = null;

        function viewProfileDetails(name, source) {
            const allProfiles = getAllDiscoverableProfiles();
            let profile = allProfiles.find(p => p.name === name);
            
            if (!profile) {
                // Check in matches
                profile = matches.find(m => m.name === name);
            }
            if (!profile) {
                // Check in chats
                profile = chats.find(c => c.name === name);
            }
            
            if (!profile) return;
            
            currentViewingProfile = profile;
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileModalContent');
            const actions = document.getElementById('profileModalActions');
            
            const galleryHtml = profile.photos.slice(1).map(photo => `
                <div class="gallery-photo" onclick="window.open('${photo}', '_blank')">
                    <img src="${photo}" alt="Photo">
                </div>
            `).join('');
            
            const showPhone = source !== 'discover';
            const phoneHtml = showPhone ? `
                <div class="info-row">
                    <div class="info-icon"><i class="fas fa-phone"></i></div>
                    <div>
                        <div class="text-white font-bold text-sm">${profile.phone}</div>
                        <div class="text-gray-400 text-xs">Phone Number</div>
                    </div>
                    <button class="ml-auto text-green-500 hover:text-green-400" onclick="window.location.href='tel:${profile.phone}'">
                        <i class="fas fa-phone-alt"></i>
                    </button>
                </div>
            ` : '';
            
            content.innerHTML = `
                <div class="profile-hero">
                    <img src="${profile.img}" alt="${profile.name}">
                    <div class="profile-hero-info">
                        <h2 class="text-3xl font-bold text-white mb-2">${profile.name}, ${profile.age}</h2>
                        <p class="text-yellow-400 text-sm"><i class="fas fa-map-marker-alt mr-2"></i>${profile.distance || 'Nearby'}  ${profile.job}</p>
                    </div>
                </div>
                
                <div class="photo-gallery">
                    ${galleryHtml}
                </div>
                
                <div class="info-section">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">About</h3>
                    <p class="text-gray-300 text-sm leading-relaxed">${profile.bio}</p>
                </div>
                
                <div class="info-section">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Info</h3>
                    
                    <div class="info-row">
                        <div class="info-icon"><i class="fas fa-briefcase"></i></div>
                        <div>
                            <div class="text-white font-bold text-sm">${profile.job}</div>
                            <div class="text-gray-400 text-xs">${profile.company}</div>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-icon"><i class="fas fa-graduation-cap"></i></div>
                        <div>
                            <div class="text-white font-bold text-sm">${profile.school}</div>
                            <div class="text-gray-400 text-xs">Education</div>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div>
                            <div class="text-white font-bold text-sm">${profile.distance || 'Nearby'}</div>
                            <div class="text-gray-400 text-xs">Distance</div>
                        </div>
                    </div>
                    
                    ${profile.country ? `
                    <div class="info-row">
                        <div class="info-icon"><i class="fas fa-globe"></i></div>
                        <div>
                            <div class="text-white font-bold text-sm">${profile.country}</div>
                            <div class="text-gray-400 text-xs">Country</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${phoneHtml}
                </div>
                
                <div class="info-section">
                    <h3 class="text-base font-bold text-yellow-500 mb-3">Interests</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">Music</span>
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">Travel</span>
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">Food</span>
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">Art</span>
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">Dancing</span>
                    </div>
                </div>
            `;
            
            if (source === 'discover') {
                actions.innerHTML = `
                    <button class="action-bar-btn dislike" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="action-bar-btn superlike" onclick="closeProfileModal(); showToast('Super Liked! ')">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="action-bar-btn like" onclick="closeProfileModal(); showToast('Liked! ')">
                        <i class="fas fa-heart"></i>
                    </button>
                `;
            } else {
                // FIXED: Always show message button for matches and chats
                actions.innerHTML = `
                    <button class="action-bar-btn dislike" onclick="unmatch('${profile.name}')">
                        <i class="fas fa-user-slash"></i>
                    </button>
                    <button class="action-bar-btn message" onclick="openChatFromProfile('${profile.name}')">
                        <i class="fas fa-comment"></i>
                    </button>
                `;
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function unmatch(name) {
            if (confirm(`Are you sure you want to unmatch with ${name}?`)) {
                showToast(`Unmatched with ${name}`);
                closeProfileModal();
                const index = matches.findIndex(m => m.name === name);
                if (index > -1) matches.splice(index, 1);
                
                // Also remove from chats
                const chatIndex = chats.findIndex(c => c.name === name);
                if (chatIndex > -1) chats.splice(chatIndex, 1);
                
                // Update storage
                if (currentUser) {
                    currentUser.matches = matches;
                    currentUser.chats = chats;
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    users[currentUser.username] = currentUser;
                    localStorage.setItem('afriConnect_users', JSON.stringify(users));
                    localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                }
                
                initMatches();
                initChats();
            }
        }

        // ==========================================
        // CHAT FUNCTIONS - FIXED
        // ==========================================
        
        function openChat(name) {
            // FIXED: Find user in matches first, then chats, then profiles
            let chat = chats.find(c => c.name === name);
            let match = matches.find(m => m.name === name);
            
            // If not in chats but in matches, create chat entry
            if (!chat && match) {
                chat = {
                    name: match.name,
                    message: "You matched! Say hello ",
                    time: "Just now",
                    unread: 0,
                    img: match.img,
                    bio: match.bio,
                    job: match.job,
                    company: match.company,
                    school: match.school,
                    phone: match.phone,
                    age: match.age,
                    photos: match.photos,
                    isBot: match.isBot || false
                };
                chats.unshift(chat);
                chatHistories[name] = [
                    { text: "You matched! Say hello ", sent: false, time: "Just now" }
                ];
                
                // Save to storage
                if (currentUser) {
                    currentUser.chats = chats;
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    users[currentUser.username] = currentUser;
                    localStorage.setItem('afriConnect_users', JSON.stringify(users));
                    localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                }
                
                initChats();
            }
            
            if (!chat) {
                showToast("Cannot start chat with this user");
                return;
            }
            
            currentChatUser = chat;
            
            document.getElementById('chatName').textContent = chat.name;
            document.getElementById('chatAvatar').src = chat.img;
            document.getElementById('chatBox').classList.add('active');
            
            renderMessages(name);
            
            chat.unread = 0;
            initChats();
        }

        function openChatFromProfile(name) {
            closeProfileModal();
            setTimeout(() => openChat(name), 300);
        }

        function closeChat() {
            document.getElementById('chatBox').classList.remove('active');
            currentChatUser = null;
        }

        function renderMessages(userName) {
            const container = document.getElementById('chatMessages');
            const messages = chatHistories[userName] || [];
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.sent ? 'sent' : 'received'}">
                    <div>${msg.text}</div>
                    <div class="message-time">${msg.time}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentChatUser) return;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (!chatHistories[currentChatUser.name]) {
                chatHistories[currentChatUser.name] = [];
            }
            
            chatHistories[currentChatUser.name].push({
                text: text,
                sent: true,
                time: time
            });
            
            // Update chat preview
            const chat = chats.find(c => c.name === currentChatUser.name);
            if (chat) {
                chat.message = text;
                chat.time = "Just now";
                initChats();
                
                // Save to storage
                if (currentUser) {
                    currentUser.chats = chats;
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    users[currentUser.username] = currentUser;
                    localStorage.setItem('afriConnect_users', JSON.stringify(users));
                    localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                }
            }
            
            input.value = '';
            renderMessages(currentChatUser.name);
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        function viewProfileFromChat() {
            if (currentChatUser) {
                viewProfileDetails(currentChatUser.name, 'messages');
            }
        }

        // ==========================================
        // MATCHES & CHATS INITIALIZATION - FIXED
        // ==========================================
        
        function initMatches() {
            // Load from currentUser if available
            if (currentUser && currentUser.matches) {
                matches = currentUser.matches;
            }
            
            const grid = document.getElementById('matchesGrid');
            
            if (matches.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #888; padding: 40px; grid-column: 1/-1;">No matches yet. Start liking profiles!</div>';
                return;
            }
            
            grid.innerHTML = matches.map(match => `
                <div class="match-card" onclick="viewProfileDetails('${match.name}', 'matches')">
                    <img src="${match.img}" alt="${match.name}">
                    <div class="match-overlay">
                        <h4 class="font-bold text-white text-sm">${match.name}, ${match.age}</h4>
                        <p class="text-xs text-green-400">${match.lastActive}</p>
                    </div>
                </div>
            `).join('');
        }

        function initChats() {
            // Load from currentUser if available
            if (currentUser && currentUser.chats) {
                chats = currentUser.chats;
                initializeChatHistories();
            }
            
            const list = document.getElementById('chatList');
            
            if (chats.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No messages yet. Match with someone to start chatting!</div>';
                return;
            }
            
            list.innerHTML = chats.map(chat => `
                <div class="chat-item" onclick="openChat('${chat.name}')">
                    <img src="${chat.img}" class="chat-avatar" alt="${chat.name}">
                    <div class="chat-preview">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-message">${chat.message}</div>
                    </div>
                    <div class="text-right">
                        <div class="chat-time">${chat.time}</div>
                        ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // TOAST NOTIFICATION
        // ==========================================
        
        function showToast(message = "It's a Match! ") {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==========================================
        // PROFILE SETTINGS FUNCTIONS
        // ==========================================
        
        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            const photos = currentUser ? (currentUser.profile.photos || [AFRICA_MAP_URL]) : userProfile.photos;
            
            photos.forEach((photo, index) => {
                const slot = document.createElement('div');
                slot.className = 'photo-slot';
                slot.innerHTML = `
                    <img src="${photo}" alt="Photo ${index + 1}">
                    ${index === 0 ? '<span class="main-photo-badge">MAIN</span>' : ''}
                    <div class="delete-photo" onclick="deletePhoto(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                grid.appendChild(slot);
            });
            
            const emptySlots = 6 - photos.length;
            for (let i = 0; i < emptySlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'photo-slot empty';
                slot.onclick = () => document.getElementById('photoUpload').click();
                slot.innerHTML = '<i class="fas fa-plus text-xl text-gray-500"></i>';
                grid.appendChild(slot);
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (currentUser) {
                        if (!currentUser.profile.photos) currentUser.profile.photos = [];
                        currentUser.profile.photos.push(e.target.result);
                    } else {
                        userProfile.photos.push(e.target.result);
                    }
                    renderPhotoGrid();
                    showToast("Photo added! ");
                };
                reader.readAsDataURL(file);
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('userAvatar').src = e.target.result;
                    if (currentUser) {
                        if (!currentUser.profile.photos) currentUser.profile.photos = [];
                        if (currentUser.profile.photos.length > 0) {
                            currentUser.profile.photos[0] = e.target.result;
                        } else {
                            currentUser.profile.photos.unshift(e.target.result);
                        }
                        // Update storage
                        const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                        users[currentUser.username] = currentUser;
                        localStorage.setItem('afriConnect_users', JSON.stringify(users));
                        localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                    } else {
                        if (userProfile.photos.length > 0) {
                            userProfile.photos[0] = e.target.result;
                        } else {
                            userProfile.photos.unshift(e.target.result);
                        }
                    }
                    renderPhotoGrid();
                    showToast("Profile photo updated! ");
                };
                reader.readAsDataURL(file);
            }
        }

        function deletePhoto(index) {
            event.stopPropagation();
            if (currentUser) {
                if (!currentUser.profile.photos) currentUser.profile.photos = [];
                currentUser.profile.photos.splice(index, 1);
            } else {
                userProfile.photos.splice(index, 1);
            }
            renderPhotoGrid();
            showToast("Photo removed");
        }

        function selectGender(element, gender) {
            document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            if (currentUser) {
                currentUser.profile.gender = gender;
            } else {
                userProfile.gender = gender;
            }
        }

        function updateSetting(key, value) {
            if (currentUser) {
                currentUser.profile[key] = value;
            } else {
                userProfile[key] = value;
            }
        }

        function updateDistance(value) {
            document.getElementById('distanceValue').textContent = value + ' km';
            if (currentUser) {
                currentUser.profile.distance = value;
            } else {
                userProfile.distance = value;
            }
        }

        function updateAgeRange() {
            const min = document.getElementById('ageMin').value;
            const max = document.getElementById('ageMax').value;
            
            if (parseInt(min) > parseInt(max)) {
                document.getElementById('ageMin').value = max;
            }
            
            const finalMin = document.getElementById('ageMin').value;
            document.getElementById('ageValue').textContent = finalMin + ' - ' + max;
            
            if (currentUser) {
                currentUser.profile.ageMin = finalMin;
                currentUser.profile.ageMax = max;
            } else {
                userProfile.ageMin = finalMin;
                userProfile.ageMax = max;
            }
        }

        // Profile Menu Functions
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function showProfileSettings() {
            document.getElementById('profileSettingsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showPrivacySettings() {
            showToast("Privacy settings - Coming soon!");
        }

        function showHelp() {
            toggleMainMenu();
            showToast("Help & Support - Contact us at support@africonnect.com");
        }

        function showAbout() {
            showToast("AfriConnect - Connecting Africa, One Heart at a Time!");
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        // Close profile menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            const menuBtn = document.querySelector('.profile-menu-btn');
            
            if (dropdown.classList.contains('active') && 
                !dropdown.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Close notification panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationPanel');
            const bell = document.querySelector('.fa-bell');
            
            if (panel.classList.contains('active') && 
                !panel.contains(e.target) && 
                !e.target.closest('button[onclick="toggleNotifications()"]')) {
                panel.classList.remove('active');
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProfileModal();
                closeChat();
                closeGroupChat();
                closeMarketDetail();
                closeCreateAdvert();
                
                document.getElementById('notificationPanel').classList.remove('active');
                document.getElementById('profileDropdown').classList.remove('active');
                document.getElementById('eniolaChat').classList.remove('active');
                
                const mainMenuPanel = document.getElementById('mainMenuPanel');
                const mainMenuOverlay = document.getElementById('mainMenuOverlay');
                if (mainMenuPanel.classList.contains('active')) {
                    mainMenuPanel.classList.remove('active');
                    mainMenuOverlay.classList.remove('active');
                }
            }
        });

        // Initialize auth on load
        initAuth();

        // ============================================
        // FIREBASE REAL-TIME MESSAGING INTEGRATION
        // ============================================
        
        // Override sendMessage to use Firebase when available
        const _originalSendMessage = sendMessage;
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChatUser) return;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const senderName = currentUser ? currentUser.profile.name : 'You';

            const messageData = {
                text: text,
                sent: true,
                time: time,
                senderId: currentUser ? currentUser.username : 'guest',
                senderName: senderName,
                timestamp: Date.now()
            };

            // Add to local history immediately for instant UI
            if (!chatHistories[currentChatUser.name]) {
                chatHistories[currentChatUser.name] = [];
            }
            chatHistories[currentChatUser.name].push(messageData);

            // Update chat preview
            const chat = chats.find(c => c.name === currentChatUser.name);
            if (chat) {
                chat.message = text;
                chat.time = "Just now";
                initChats();
                if (currentUser) {
                    currentUser.chats = chats;
                    const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                    users[currentUser.username] = currentUser;
                    localStorage.setItem('afriConnect_users', JSON.stringify(users));
                    localStorage.setItem('afriConnect_session', JSON.stringify(currentUser));
                }
            }

            input.value = '';
            renderMessages(currentChatUser.name);

            // Send to Firebase if available
            if (window._firebase && window._firebase.ready) {
                const conversationId = [currentUser ? currentUser.username : 'guest', currentChatUser.name]
                    .sort().join('_');
                const fbMsg = { ...messageData };
                await window._sendFirebaseMessage(conversationId, fbMsg);
            }
        };

        // Override sendGroupMessage to use Firebase
        const _originalSendGroupMessage = sendGroupMessage;
        window.sendGroupMessage = async function() {
            const input = document.getElementById('groupChatInput');
            const text = input.value.trim();
            if (!text || !currentGroupRoom) return;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const senderName = currentUser ? currentUser.profile.name : 'Anonymous';
            const key = `${currentGroupRoom.country}-${currentGroupRoom.room}`;

            if (!groupChatHistories[key]) groupChatHistories[key] = [];

            const msgData = {
                text: text,
                sent: true,
                time: time,
                user: senderName,
                userId: currentUser ? currentUser.username : 'guest',
                timestamp: Date.now()
            };

            groupChatHistories[key].push(msgData);
            input.value = '';
            renderGroupMessages(currentGroupRoom.country, currentGroupRoom.room);

            // Send to Firebase
            if (window._firebase && window._firebase.ready) {
                const roomId = key.replace(/[^a-zA-Z0-9_-]/g, '_');
                await window._sendGroupFirebaseMessage(roomId, msgData);
            }
        };

        // Override openChat to set up Firebase listener
        const _originalOpenChat = openChat;
        window.openChat = function(name) {
            _originalOpenChat(name);
            
            if (window._firebase && window._firebase.ready && currentUser) {
                const conversationId = [currentUser.username, name.toLowerCase().replace(/\s+/g, '_')]
                    .sort().join('_');
                
                window._listenToConversation(conversationId, (msg, key) => {
                    // Only add if not from us (avoid duplicates)
                    if (msg.senderId !== (currentUser ? currentUser.username : 'guest')) {
                        if (!chatHistories[name]) chatHistories[name] = [];
                        
                        const exists = chatHistories[name].some(m => m.timestamp === msg.timestamp && m.text === msg.text);
                        if (!exists) {
                            chatHistories[name].push({ ...msg, sent: false });
                            if (currentChatUser && currentChatUser.name === name) {
                                renderMessages(name);
                            }
                        }
                    }
                });
            }
        };

        // ============================================
        // ADMIN PANEL FUNCTIONS
        // ============================================
        
        const ADMIN_CODE = 'ENNY5969@';
        let adminAuthenticated = false;

        window.openAdminPanel = function() {
            toggleMainMenu();
            
            if (adminAuthenticated) {
                showAdminMainPanel();
                return;
            }
            
            const lockScreen = document.getElementById('adminLockScreen');
            lockScreen.style.display = 'flex';
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminCodeError').style.display = 'none';
            setTimeout(() => document.getElementById('adminCodeInput').focus(), 100);
        };

        window.verifyAdminCode = function() {
            const code = document.getElementById('adminCodeInput').value;
            if (code === ADMIN_CODE) {
                adminAuthenticated = true;
                document.getElementById('adminLockScreen').style.display = 'none';
                showAdminMainPanel();
            } else {
                const input = document.getElementById('adminCodeInput');
                const err = document.getElementById('adminCodeError');
                input.style.borderColor = '#ef4444';
                err.style.display = 'block';
                input.value = '';
                setTimeout(() => input.focus(), 100);
            }
        };

        window.toggleAdminCodeVis = function() {
            const input = document.getElementById('adminCodeInput');
            const icon = document.getElementById('adminEyeIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        };

        window.closeAdminPanel = function() {
            document.getElementById('adminLockScreen').style.display = 'none';
            document.getElementById('adminMainPanel').style.display = 'none';
        };

        function showAdminMainPanel() {
            const panel = document.getElementById('adminMainPanel');
            panel.style.display = 'flex';
            switchAdminTab('dashboard');
            
            // Update firebase status indicator
            if (window._firebase && window._firebase.ready) {
                document.getElementById('adminFirebaseStatus').innerHTML = 
                    '<span class="realtime-dot"></span>Firebase Live';
                document.getElementById('adminFirebaseStatus').style.color = '#22c55e';
            } else {
                document.getElementById('adminFirebaseStatus').innerHTML = 
                    ' LocalStorage Mode';
                document.getElementById('adminFirebaseStatus').style.color = '#fbbf24';
            }
        }

        window.switchAdminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => {
                if (t.dataset.tab === tab) t.classList.add('active');
            });
            renderAdminTab(tab);
        };

        async function renderAdminTab(tab) {
            const content = document.getElementById('adminContent');
            
            if (tab === 'dashboard') {
                content.innerHTML = '<div style="display:flex;align-items:center;gap:10px;color:#888;padding:40px;justify-content:center;"><i class="fas fa-spinner fa-spin" style="color:#fbbf24;"></i> Loading stats...</div>';
                
                const stats = window._adminGetStats ? await window._adminGetStats() : { totalUsers: 0, totalMsgConvs: 0, totalMsgCount: 0 };
                const users = await window._adminGetAllUsers();
                const userCount = Object.keys(users).length;
                
                const fbMode = (window._firebase && window._firebase.ready) ? 
                    '<span style="color:#22c55e"><i class="fas fa-check-circle"></i> Firebase Realtime Database</span>' :
                    '<span style="color:#fbbf24"><i class="fas fa-exclamation-triangle"></i> LocalStorage (Firebase not configured)</span>';

                content.innerHTML = `
                    <h2 style="color:#fbbf24;font-size:20px;margin-bottom:20px;font-family:'Playfair Display',serif;">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </h2>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:15px;margin-bottom:25px;">
                        <div class="admin-stat-card">
                            <div style="color:#888;font-size:12px;margin-bottom:8px;">TOTAL USERS</div>
                            <div style="color:white;font-size:36px;font-weight:bold;">${userCount}</div>
                            <div style="color:#22c55e;font-size:12px;margin-top:4px;"><i class="fas fa-user-plus"></i> Registered</div>
                        </div>
                        <div class="admin-stat-card">
                            <div style="color:#888;font-size:12px;margin-bottom:8px;">CONVERSATIONS</div>
                            <div style="color:white;font-size:36px;font-weight:bold;">${stats.totalMsgConvs || 0}</div>
                            <div style="color:#3b82f6;font-size:12px;margin-top:4px;"><i class="fas fa-comments"></i> Active chats</div>
                        </div>
                        <div class="admin-stat-card">
                            <div style="color:#888;font-size:12px;margin-bottom:8px;">MESSAGES SENT</div>
                            <div style="color:white;font-size:36px;font-weight:bold;">${stats.totalMsgCount || 0}</div>
                            <div style="color:#fbbf24;font-size:12px;margin-top:4px;"><i class="fas fa-paper-plane"></i> Total</div>
                        </div>
                        <div class="admin-stat-card">
                            <div style="color:#888;font-size:12px;margin-bottom:8px;">ADVERTS</div>
                            <div style="color:white;font-size:36px;font-weight:bold;">${Object.values(users).reduce((acc, u) => acc + (u.adverts ? u.adverts.length : 0), 0)}</div>
                            <div style="color:#a855f7;font-size:12px;margin-top:4px;"><i class="fas fa-store"></i> Marketplace</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:20px;">
                        <h3 style="color:white;font-size:16px;margin-bottom:12px;"><i class="fas fa-database" style="color:#fbbf24;"></i> Database Status</h3>
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.08);">
                            <span style="color:#ccc;font-size:14px;">Backend Mode</span>
                            <span style="font-size:14px;">${fbMode}</span>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.08);">
                            <span style="color:#ccc;font-size:14px;">Real-time Messaging</span>
                            <span style="color:${window._firebase && window._firebase.ready ? '#22c55e' : '#ef4444'};font-size:14px;">
                                ${window._firebase && window._firebase.ready ? ' Active' : ' Requires Firebase Config'}
                            </span>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;">
                            <span style="color:#ccc;font-size:14px;">Admin Code</span>
                            <span style="color:#22c55e;font-size:14px;"><i class="fas fa-lock"></i> Protected</span>
                        </div>
                    </div>

                    <div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.2);border-radius:16px;padding:20px;">
                        <h3 style="color:#fbbf24;margin-bottom:10px;font-size:15px;"><i class="fas fa-info-circle"></i> Setup Guide</h3>
                        <p style="color:#ccc;font-size:13px;line-height:1.7;">
                            To enable full real-time Firebase features:<br>
                            1. Create a project at <strong style="color:#fbbf24;">console.firebase.google.com</strong><br>
                            2. Enable <strong>Realtime Database</strong> and <strong>Authentication</strong><br>
                            3. Copy your config and replace the <code style="color:#fbbf24;background:rgba(251,191,36,0.1);padding:2px 6px;border-radius:4px;">firebaseConfig</code> object in the &lt;script type="module"&gt; block<br>
                            4. Set database rules to allow authenticated users<br>
                            5. Done! Messages will sync in real-time across all devices.
                        </p>
                    </div>
                `;
            }
            
            else if (tab === 'users') {
                content.innerHTML = '<div style="text-align:center;padding:40px;color:#888;"><i class="fas fa-spinner fa-spin" style="color:#fbbf24;font-size:24px;"></i></div>';
                const users = await window._adminGetAllUsers();
                const userList = Object.values(users);

                content.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="color:#fbbf24;font-size:20px;font-family:'Playfair Display',serif;">
                            <i class="fas fa-users"></i> Registered Users (${userList.length})
                        </h2>
                        <button onclick="refreshAdminUsers()" style="
                            background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);
                            color:#fbbf24;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:13px;">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;margin-bottom:15px;">
                        <input class="admin-input" placeholder="Search users..." oninput="filterAdminUsers(this.value)" id="adminUserSearch" style="margin-bottom:0;">
                    </div>
                    
                    <div id="adminUserList">
                        ${userList.length === 0 ? '<p style="text-align:center;color:#888;padding:40px;">No registered users yet</p>' : 
                            userList.map(user => `
                                <div class="admin-user-row" id="userRow_${user.username}">
                                    <img src="${user.profile && user.profile.photos && user.profile.photos[0] ? user.profile.photos[0] : 'https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg'}" 
                                        style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid #fbbf24;">
                                    <div style="flex:1">
                                        <div style="color:white;font-weight:bold;font-size:14px;">${user.profile ? user.profile.name : user.username} <span class="admin-badge admin-badge-yellow" style="font-size:10px;">@${user.username}</span></div>
                                        <div style="color:#888;font-size:12px;">${user.profile ? (user.profile.bio || 'No bio') : 'No profile'}</div>
                                        <div style="color:#666;font-size:11px;margin-top:3px;">
                                            <i class="fas fa-heart" style="color:#ef4444;"></i> ${user.matches ? user.matches.length : 0} matches &nbsp;
                                            <i class="fas fa-comment" style="color:#3b82f6;"></i> ${user.chats ? user.chats.length : 0} chats &nbsp;
                                            <i class="fas fa-store" style="color:#a855f7;"></i> ${user.adverts ? user.adverts.length : 0} adverts
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end;">
                                        <span class="admin-badge admin-badge-green">Active</span>
                                        <button onclick="adminDeleteUser('${user.username}')" class="admin-action-btn" 
                                            style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.2);">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                
                window._currentAdminUsers = userList;
            }
            
            else if (tab === 'messages') {
                content.innerHTML = `
                    <h2 style="color:#fbbf24;font-size:20px;margin-bottom:20px;font-family:'Playfair Display',serif;">
                        <i class="fas fa-comments"></i> Message Monitor
                    </h2>
                    
                    <div style="background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:12px;padding:20px;margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <span class="realtime-dot"></span>
                            <strong style="color:white;">Real-time Message Feed</strong>
                            <span class="admin-badge admin-badge-green">Live</span>
                        </div>
                        <p style="color:#888;font-size:13px;">
                            ${window._firebase && window._firebase.ready ? 
                                'Firebase is active. All messages are stored and synced in real-time.' :
                                'Firebase not configured. Messages are stored locally per-device. Configure Firebase to enable cross-device real-time chat.'}
                        </p>
                    </div>
                    
                    <div id="adminMsgsList">
                        <div style="text-align:center;padding:40px;color:#888;">
                            <i class="fas fa-spinner fa-spin" style="color:#fbbf24;font-size:24px;"></i><br><br>
                            Loading messages...
                        </div>
                    </div>
                `;
                
                setTimeout(async () => {
                    const msgs = await window._adminGetAllMessages();
                    const msgsList = document.getElementById('adminMsgsList');
                    
                    if (Object.keys(msgs).length === 0) {
                        // Load from localStorage as fallback
                        const users = JSON.parse(localStorage.getItem('afriConnect_users')) || {};
                        let localMsgCount = 0;
                        Object.values(users).forEach(u => {
                            if (u.chats) localMsgCount += u.chats.length;
                        });
                        msgsList.innerHTML = `
                            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;">
                                <p style="color:#888;text-align:center;">No Firebase messages yet. ${localMsgCount} local chat sessions found.</p>
                                <p style="color:#666;text-align:center;font-size:12px;margin-top:8px;">Messages will appear here once Firebase is configured and users start chatting.</p>
                            </div>`;
                        return;
                    }
                    
                    const convIds = Object.keys(msgs);
                    msgsList.innerHTML = convIds.map(convId => {
                        const convMsgs = Object.values(msgs[convId] || {});
                        return `
                            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;margin-bottom:12px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <h4 style="color:#fbbf24;font-size:14px;"><i class="fas fa-comment-dots"></i> ${convId.replace(/_/g, '  ')}</h4>
                                    <span class="admin-badge admin-badge-yellow">${convMsgs.length} msgs</span>
                                </div>
                                ${convMsgs.slice(-3).map(m => `
                                    <div style="display:flex;gap:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px;">
                                        <div style="color:#fbbf24;font-size:12px;font-weight:bold;min-width:80px;">${m.senderName || m.user || 'Unknown'}</div>
                                        <div style="color:#ccc;font-size:13px;flex:1;">${m.text}</div>
                                        <div style="color:#666;font-size:11px;">${m.time || ''}</div>
                                    </div>
                                `).join('')}
                            </div>`;
                    }).join('');
                }, 500);
            }
            
            else if (tab === 'firebase') {
                const isReady = window._firebase && window._firebase.ready;
                content.innerHTML = `
                    <h2 style="color:#fbbf24;font-size:20px;margin-bottom:20px;font-family:'Playfair Display',serif;">
                        <i class="fas fa-database"></i> Firebase Configuration
                    </h2>
                    
                    <div style="background:${isReady ? 'rgba(34,197,94,0.05)' : 'rgba(239,68,68,0.05)'};border:1px solid ${isReady ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};border-radius:12px;padding:20px;margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <i class="fas fa-${isReady ? 'check-circle' : 'exclamation-circle'}" style="color:${isReady ? '#22c55e' : '#ef4444'};font-size:24px;"></i>
                            <div>
                                <div style="color:white;font-weight:bold;">${isReady ? 'Firebase Connected' : 'Firebase Not Configured'}</div>
                                <div style="color:#888;font-size:13px;">${isReady ? 'Real-time database is active and working.' : 'Replace the firebaseConfig in the code with your real project credentials.'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:20px;">
                        <h3 style="color:white;margin-bottom:15px;">How to Configure Firebase</h3>
                        
                        <div style="counter-reset:steps;">
                            ${['Go to console.firebase.google.com',
                               'Click "Add Project" and follow the setup wizard',
                               'In your project, click "Web" (</>) to add a web app',
                               'Copy the firebaseConfig object provided',
                               'In this HTML file, find the &lt;script type="module"&gt; block near the top',
                               'Replace the placeholder firebaseConfig with your real one',
                               'Enable "Realtime Database" in Firebase Console  Build  Realtime Database',
                               'Set rules: allow read, write: if request.auth != null',
                               'Enable "Authentication"  Sign-in method  Email/Password'
                            ].map((step, i) => `
                                <div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);">
                                    <div style="width:24px;height:24px;background:rgba(251,191,36,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fbbf24;font-size:12px;font-weight:bold;flex-shrink:0;">${i+1}</div>
                                    <div style="color:#ccc;font-size:13px;line-height:1.5;">${step}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;">
                        <h3 style="color:#fbbf24;margin-bottom:12px;font-size:14px;"><i class="fas fa-code"></i> Example Database Rules</h3>
                        <pre style="color:#22c55e;font-size:12px;line-height:1.8;overflow-x:auto;">{
  "rules": {
    "messages": {
      "$convId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "groupMessages": {
      "$roomId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "users": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth.uid === $uid || auth.token.admin === true"
      }
    }
  }
}</pre>
                    </div>
                `;
            }
            
            else if (tab === 'broadcast') {
                content.innerHTML = `
                    <h2 style="color:#fbbf24;font-size:20px;margin-bottom:20px;font-family:'Playfair Display',serif;">
                        <i class="fas fa-bullhorn"></i> Broadcast Message
                    </h2>
                    
                    <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;">
                        <p style="color:#888;font-size:13px;margin-bottom:20px;">
                            Send a notification to all registered users. This will appear in their notifications panel.
                        </p>
                        
                        <div style="margin-bottom:15px;">
                            <label style="color:#fbbf24;font-size:13px;display:block;margin-bottom:6px;">Message Title</label>
                            <input class="admin-input" id="broadcastTitle" placeholder="e.g. New feature available!">
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="color:#fbbf24;font-size:13px;display:block;margin-bottom:6px;">Message Body</label>
                            <textarea class="admin-input" id="broadcastBody" style="min-height:100px;resize:vertical;" placeholder="Write your announcement here..."></textarea>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#fbbf24;font-size:13px;display:block;margin-bottom:6px;">Message Type</label>
                            <select class="admin-input" id="broadcastType" style="cursor:pointer;">
                                <option value="announcement"> Announcement</option>
                                <option value="update"> App Update</option>
                                <option value="promo"> Promotion</option>
                                <option value="warning"> Important Notice</option>
                            </select>
                        </div>
                        
                        <button onclick="sendAdminBroadcast()" style="
                            width:100%;background:linear-gradient(135deg,#fbbf24,#d4af37);color:black;
                            border:none;border-radius:12px;padding:15px;font-size:16px;font-weight:bold;
                            cursor:pointer;transition:all 0.3s;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-paper-plane"></i> Send Broadcast
                        </button>
                        
                        <div id="broadcastStatus" style="margin-top:15px;text-align:center;display:none;"></div>
                    </div>
                `;
            }
        }

        window.refreshAdminUsers = function() {
            switchAdminTab('users');
        };
        
        window.filterAdminUsers = function(query) {
            const users = window._currentAdminUsers || [];
            const filtered = users.filter(u => 
                (u.username || '').includes(query.toLowerCase()) ||
                (u.profile && (u.profile.name || '').toLowerCase().includes(query.toLowerCase()))
            );
            
            const list = document.getElementById('adminUserList');
            if (!list) return;
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#888;padding:20px;">No users found</p>';
                return;
            }
            
            list.innerHTML = filtered.map(user => `
                <div class="admin-user-row">
                    <img src="${user.profile && user.profile.photos && user.profile.photos[0] ? user.profile.photos[0] : 'https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg'}" 
                        style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid #fbbf24;">
                    <div style="flex:1">
                        <div style="color:white;font-weight:bold;font-size:14px;">${user.profile ? user.profile.name : user.username} <span class="admin-badge admin-badge-yellow" style="font-size:10px;">@${user.username}</span></div>
                        <div style="color:#888;font-size:12px;">${user.profile ? (user.profile.bio || 'No bio') : 'No profile'}</div>
                    </div>
                    <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end;">
                        <span class="admin-badge admin-badge-green">Active</span>
                        <button onclick="adminDeleteUser('${user.username}')" class="admin-action-btn" 
                            style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.2);">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        };

        window.adminDeleteUser = async function(username) {
            if (!confirm(`Are you sure you want to delete user @${username}? This cannot be undone.`)) return;
            
            const success = await window._adminDeleteUser(username);
            if (success) {
                const row = document.getElementById(`userRow_${username}`);
                if (row) { row.style.opacity = '0.3'; row.style.pointerEvents = 'none'; }
                showToast(`User @${username} deleted `);
                setTimeout(() => switchAdminTab('users'), 1000);
            } else {
                showToast('Failed to delete user');
            }
        };

        window.sendAdminBroadcast = function() {
            const title = document.getElementById('broadcastTitle').value.trim();
            const body = document.getElementById('broadcastBody').value.trim();
            const type = document.getElementById('broadcastType').value;
            
            if (!title || !body) {
                showToast('Please fill in all fields');
                return;
            }
            
            const typeEmojis = { announcement: '', update: '', promo: '', warning: '' };
            const emoji = typeEmojis[type] || '';
            
            addNotification({
                id: Date.now(),
                type: 'broadcast',
                user: 'AfriConnect Admin',
                avatar: 'https://static.vecteezy.com/system/resources/previews/006/580/686/non_2x/map-of-africa-on-black-background-vector.jpg',
                text: `${emoji} <strong>${title}</strong>: ${body}`,
                time: 'Just now',
                read: false
            });
            
            const status = document.getElementById('broadcastStatus');
            status.style.display = 'block';
            status.innerHTML = '<span style="color:#22c55e;"><i class="fas fa-check-circle"></i> Broadcast sent successfully!</span>';
            
            document.getElementById('broadcastTitle').value = '';
            document.getElementById('broadcastBody').value = '';
            
            showToast(`Broadcast sent! ${emoji}`);
            setTimeout(() => { status.style.display = 'none'; }, 3000);
        };

        // ==========================================
        // DARK / LIGHT MODE
        // ==========================================
        let _isDarkMode = true;
        function toggleDarkLight() {
            _isDarkMode = !_isDarkMode;
            document.body.classList.toggle('light-mode', !_isDarkMode);
            const icon = document.getElementById('darkLightIcon');
            const label = document.getElementById('darkLightLabel');
            const tog = document.getElementById('darkLightToggle');
            if (_isDarkMode) {
                icon.className = 'fas fa-moon';
                label.textContent = 'Dark Mode';
                tog.classList.add('active');
            } else {
                icon.className = 'fas fa-sun';
                label.textContent = 'Light Mode';
                tog.classList.remove('active');
            }
            localStorage.setItem('afriConnect_darkMode', _isDarkMode ? '1' : '0');
        }

        // ==========================================
        // DESKTOP / MOBILE MODE
        // ==========================================
        let _isDesktopMode = false;
        function toggleDesktopMode() {
            _isDesktopMode = !_isDesktopMode;
            document.body.classList.toggle('desktop-mode', _isDesktopMode);
            const icon = document.getElementById('desktopModeIcon');
            const label = document.getElementById('desktopModeLabel');
            const tog = document.getElementById('desktopModeToggle');
            if (_isDesktopMode) {
                icon.className = 'fas fa-mobile-alt';
                label.textContent = 'Mobile Mode';
                tog.classList.add('active');
            } else {
                icon.className = 'fas fa-desktop';
                label.textContent = 'Desktop Mode';
                tog.classList.remove('active');
            }
            localStorage.setItem('afriConnect_desktopMode', _isDesktopMode ? '1' : '0');
            showToast(_isDesktopMode ? ' Desktop mode ON' : ' Mobile mode ON');
        }

        // Restore preferences
        (function restorePrefs() {
            const dm = localStorage.getItem('afriConnect_darkMode');
            if (dm === '0') { _isDarkMode = true; toggleDarkLight(); } // start dark, toggle to light
            const desktop = localStorage.getItem('afriConnect_desktopMode');
            if (desktop === '1') { _isDesktopMode = false; toggleDesktopMode(); }
        })();

        // ==========================================
        // PWA INSTALL BUTTON
        // ==========================================
        let _deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            _deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            if (btn) {
                btn.disabled = false;
                btn.querySelector('#installBtnText').textContent = 'Install App';
            }
        });

        window.addEventListener('appinstalled', () => {
            _deferredPrompt = null;
            const btn = document.getElementById('installAppBtn');
            if (btn) {
                btn.disabled = true;
                btn.querySelector('#installBtnText').textContent = 'App Installed ';
            }
            showToast('AfriConnect installed! ');
        });

        async function installApp() {
            const btn = document.getElementById('installAppBtn');
            if (_deferredPrompt) {
                _deferredPrompt.prompt();
                const { outcome } = await _deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showToast('Installing AfriConnect...');
                }
                _deferredPrompt = null;
            } else {
                // Fallback instructions
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    showToast('Tap Share  Add to Home Screen ');
                } else {
                    showToast('Open browser menu  Install App / Add to Home Screen');
                }
            }
        }

        // ==========================================
        // FLASH SECTION - Firebase + localStorage
        // ==========================================
        
        let _flashImageData = null;

        function openFlashCreate() {
            document.getElementById('flashCreateModal').classList.add('active');
        }

        function closeFlashCreate() {
            document.getElementById('flashCreateModal').classList.remove('active');
            clearFlashImage();
            document.getElementById('flashCaption').value = '';
        }

        function previewFlashImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                _flashImageData = e.target.result;
                document.getElementById('flashUploadArea').style.display = 'none';
                document.getElementById('flashImagePreview').style.display = 'block';
                document.getElementById('flashPreviewImg').src = _flashImageData;
            };
            reader.readAsDataURL(file);
        }

        function clearFlashImage() {
            _flashImageData = null;
            document.getElementById('flashUploadArea').style.display = 'block';
            document.getElementById('flashImagePreview').style.display = 'none';
            document.getElementById('flashImageInput').value = '';
        }

        async function submitFlashPost() {
            if (!currentUser) { showToast('Please login first'); return; }
            const caption = document.getElementById('flashCaption').value.trim();
            if (!_flashImageData && !caption) {
                showToast('Please add an image or caption'); return;
            }

            const post = {
                id: 'flash_' + Date.now(),
                authorUsername: currentUser.username,
                authorName: currentUser.profile.name,
                authorAvatar: currentUser.profile.photos[0] || AFRICA_MAP_URL,
                imageData: _flashImageData || null,
                caption: caption,
                timestamp: Date.now(),
                expiresAt: Date.now() + (48 * 60 * 60 * 1000), // 48 hours
                likes: [],
                comments: []
            };

            // Save to Firebase if available
            if (window._firebase && window._firebase.ready && window._firebase.db) {
                try {
                    await window._firebase.push(
                        window._firebase.ref(window._firebase.db, 'flashPosts'),
                        post
                    );
                } catch(e) {
                    console.warn('Firebase flash save failed, using localStorage', e);
                    saveFlashToLocal(post);
                }
            } else {
                saveFlashToLocal(post);
            }

            showToast('Flash posted!  Expires in 48hrs');
            closeFlashCreate();
            loadFlashFeed();
        }

        function saveFlashToLocal(post) {
            const posts = JSON.parse(localStorage.getItem('afriConnect_flashPosts') || '[]');
            posts.unshift(post);
            localStorage.setItem('afriConnect_flashPosts', JSON.stringify(posts));
        }

        async function loadFlashFeed() {
            const feed = document.getElementById('flashFeed');
            if (!feed) return;
            feed.innerHTML = '<div style="text-align:center;padding:40px;color:#888;"><i class="fas fa-spinner fa-spin" style="color:#fbbf24;font-size:24px;"></i></div>';

            let posts = [];
            const now = Date.now();

            if (window._firebase && window._firebase.ready && window._firebase.db) {
                try {
                    const snap = await window._firebase.get(
                        window._firebase.ref(window._firebase.db, 'flashPosts')
                    );
                    if (snap.val()) {
                        const all = Object.entries(snap.val()).map(([key, val]) => ({...val, _fbKey: key}));
                        // Filter expired & sort newest first
                        posts = all.filter(p => p.expiresAt > now).sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Auto-delete expired ones from Firebase
                        all.filter(p => p.expiresAt <= now).forEach(async (p) => {
                            try {
                                await window._firebase.remove(
                                    window._firebase.ref(window._firebase.db, `flashPosts/${p._fbKey}`)
                                );
                            } catch(e){}
                        });
                    }
                } catch(e) {
                    posts = getLocalFlashPosts(now);
                }
            } else {
                posts = getLocalFlashPosts(now);
            }

            if (posts.length === 0) {
                feed.innerHTML = `
                    <div style="text-align:center;padding:60px 20px;color:#888;">
                        <i class="fas fa-bolt" style="font-size:48px;color:rgba(251,191,36,0.3);margin-bottom:16px;display:block;"></i>
                        <p style="font-size:16px;margin-bottom:8px;color:#ccc;">No flashes yet!</p>
                        <p style="font-size:13px;">Be the first to post a 48-hour flash</p>
                    </div>`;
                return;
            }

            feed.innerHTML = posts.map(post => renderFlashPost(post, now)).join('');
        }

        function getLocalFlashPosts(now) {
            const posts = JSON.parse(localStorage.getItem('afriConnect_flashPosts') || '[]');
            const valid = posts.filter(p => p.expiresAt > now);
            // Clean up expired
            if (valid.length !== posts.length) {
                localStorage.setItem('afriConnect_flashPosts', JSON.stringify(valid));
            }
            return valid.sort((a, b) => b.timestamp - a.timestamp);
        }

        function renderFlashPost(post, now) {
            const remaining = post.expiresAt - now;
            const hoursLeft = Math.max(0, Math.floor(remaining / 3600000));
            const minsLeft = Math.max(0, Math.floor((remaining % 3600000) / 60000));
            const timeLabel = hoursLeft > 0 ? `${hoursLeft}h ${minsLeft}m left` : `${minsLeft}m left`;

            const postDate = new Date(post.timestamp);
            const timeAgo = getTimeAgo(post.timestamp);

            const likes = post.likes || [];
            const comments = post.comments || [];
            const isLiked = currentUser && likes.includes(currentUser.username);

            const imageHtml = post.imageData ? 
                `<img src="${post.imageData}" class="flash-post-image" alt="Flash post" onclick="fullscreenFlashImage(this)">` : '';

            const commentsHtml = comments.slice(0, 3).map(c => `
                <div class="flash-comment">
                    <img src="${c.avatar || AFRICA_MAP_URL}" class="flash-comment-avatar" alt="">
                    <div>
                        <span class="flash-comment-user">${c.authorName}</span>
                        <div class="flash-comment-text">${c.text}</div>
                    </div>
                </div>
            `).join('');

            return `
            <div class="flash-post-card" data-post-id="${post.id}" data-fb-key="${post._fbKey || ''}">
                <div class="flash-post-header">
                    <img src="${post.authorAvatar}" class="flash-post-avatar" alt="">
                    <div>
                        <div class="post-username">${post.authorName}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                    <div class="flash-expiry"><i class="fas fa-clock"></i> ${timeLabel}</div>
                </div>
                ${imageHtml}
                ${post.caption ? `<div class="flash-post-caption">${post.caption}</div>` : ''}
                <div class="flash-actions">
                    <button class="flash-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleFlashLike('${post.id}', '${post._fbKey || ''}', this)">
                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                        <span>${likes.length}</span>
                    </button>
                    <button class="flash-action-btn" onclick="toggleFlashComments('${post.id}', this)">
                        <i class="far fa-comment"></i>
                        <span>${comments.length}</span>
                    </button>
                    <button class="flash-action-btn" onclick="shareFlashPost('${post.id}')">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
                <div class="flash-comments-section" id="flashComments_${post.id}">
                    <div id="flashCommentsList_${post.id}">${commentsHtml}</div>
                    <div class="flash-comment-input-row">
                        <input type="text" class="flash-comment-input" placeholder="Add a comment..." id="flashCommentInput_${post.id}" 
                            onkeypress="if(event.key==='Enter') submitFlashComment('${post.id}', '${post._fbKey || ''}')">
                        <button class="flash-comment-send" onclick="submitFlashComment('${post.id}', '${post._fbKey || ''}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function getTimeAgo(ts) {
            const diff = Date.now() - ts;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
            return `${Math.floor(diff/86400000)}d ago`;
        }

        function toggleFlashComments(postId, btn) {
            const section = document.getElementById(`flashComments_${postId}`);
            section.classList.toggle('open');
            if (section.classList.contains('open')) {
                document.getElementById(`flashCommentInput_${postId}`).focus();
            }
        }

        async function toggleFlashLike(postId, fbKey, btn) {
            if (!currentUser) { showToast('Login to like posts'); return; }
            const uname = currentUser.username;

            // Optimistic UI
            const isNowLiked = !btn.classList.contains('liked');
            btn.classList.toggle('liked', isNowLiked);
            const icon = btn.querySelector('i');
            icon.className = isNowLiked ? 'fas fa-heart' : 'far fa-heart';
            const countSpan = btn.querySelector('span');
            let count = parseInt(countSpan.textContent);
            countSpan.textContent = isNowLiked ? count + 1 : Math.max(0, count - 1);

            if (window._firebase && window._firebase.ready && window._firebase.db && fbKey) {
                try {
                    const postRef = window._firebase.ref(window._firebase.db, `flashPosts/${fbKey}`);
                    const snap = await window._firebase.get(postRef);
                    if (snap.val()) {
                        const post = snap.val();
                        const likes = post.likes || [];
                        const idx = likes.indexOf(uname);
                        if (idx > -1) likes.splice(idx, 1);
                        else likes.push(uname);
                        await window._firebase.update(postRef, { likes });
                    }
                } catch(e) { updateLocalFlashLike(postId, uname, isNowLiked); }
            } else {
                updateLocalFlashLike(postId, uname, isNowLiked);
            }
        }

        function updateLocalFlashLike(postId, uname, add) {
            const posts = JSON.parse(localStorage.getItem('afriConnect_flashPosts') || '[]');
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const idx = post.likes.indexOf(uname);
            if (add && idx === -1) post.likes.push(uname);
            else if (!add && idx > -1) post.likes.splice(idx, 1);
            localStorage.setItem('afriConnect_flashPosts', JSON.stringify(posts));
        }

        async function submitFlashComment(postId, fbKey) {
            if (!currentUser) { showToast('Login to comment'); return; }
            const input = document.getElementById(`flashCommentInput_${postId}`);
            const text = input.value.trim();
            if (!text) return;
            input.value = '';

            const comment = {
                id: 'c' + Date.now(),
                authorUsername: currentUser.username,
                authorName: currentUser.profile.name,
                avatar: currentUser.profile.photos[0] || AFRICA_MAP_URL,
                text: text,
                timestamp: Date.now()
            };

            // Add to UI
            const list = document.getElementById(`flashCommentsList_${postId}`);
            list.insertAdjacentHTML('beforeend', `
                <div class="flash-comment">
                    <img src="${comment.avatar}" class="flash-comment-avatar" alt="">
                    <div>
                        <span class="flash-comment-user">${comment.authorName}</span>
                        <div class="flash-comment-text">${comment.text}</div>
                    </div>
                </div>`);

            if (window._firebase && window._firebase.ready && window._firebase.db && fbKey) {
                try {
                    const commentsRef = window._firebase.ref(window._firebase.db, `flashPosts/${fbKey}/comments`);
                    const snap = await window._firebase.get(commentsRef.parent);
                    if (snap.val()) {
                        const comments = snap.val().comments || [];
                        comments.push(comment);
                        await window._firebase.update(snap.ref, { comments });
                    }
                } catch(e) { addLocalFlashComment(postId, comment); }
            } else {
                addLocalFlashComment(postId, comment);
            }
        }

        function addLocalFlashComment(postId, comment) {
            const posts = JSON.parse(localStorage.getItem('afriConnect_flashPosts') || '[]');
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            if (!post.comments) post.comments = [];
            post.comments.push(comment);
            localStorage.setItem('afriConnect_flashPosts', JSON.stringify(posts));
        }

        function shareFlashPost(postId) {
            if (navigator.share) {
                navigator.share({ title: 'AfriConnect Flash', text: 'Check out this Flash post!', url: window.location.href });
            } else {
                showToast('Share: ' + window.location.href);
            }
        }

        function fullscreenFlashImage(img) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
            const i = document.createElement('img');
            i.src = img.src;
            i.style.cssText = 'max-width:95vw;max-height:95vh;object-fit:contain;border-radius:8px;';
            overlay.appendChild(i);
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }

        // Override showSection to handle flash button visibility
        const _origShowSection = window.showSection || function(){};
        function showSection(section) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`section-${section}`).classList.add('active');
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            // Show/hide flash create button
            const flashBtn = document.getElementById('flashCreateBtn');
            if (flashBtn) {
                flashBtn.classList.toggle('visible', section === 'nearby');
            }
            // Load flash feed when switching to flash tab
            if (section === 'nearby') {
                loadFlashFeed();
            }
        }

        // Also override initNearby to init flash instead
        function initNearby() {
            loadFlashFeed();
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create inline service worker
                const swContent = `
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                    self.addEventListener('fetch', e => {
                        if (e.request.destination === 'image') {
                            e.respondWith(
                                caches.open('africonnect-v1').then(cache =>
                                    cache.match(e.request).then(r => r || fetch(e.request).then(res => {
                                        cache.put(e.request, res.clone()); return res;
                                    }))
                                )
                            );
                        }
                    });
                `;
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                navigator.serviceWorker.register(url).catch(() => {});
            });
        }

    </script>
</body>
</html>